/*! Version: 0.2.3 */
var HTML2PDF4DOC;(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{init:()=>cn});var n={};e.r(n),e.d(n,{logGroup:()=>w,logGroupEnd:()=>S});var o={};e.r(o),e.d(o,{isAfterContentFlowStart:()=>I,isComplexTextBlock:()=>G,isContentFlowEnd:()=>W,isContentFlowStart:()=>R,isForcedPageBreak:()=>U,isFullySPlitted:()=>ee,isGrid:()=>K,isGridAutoFlowRow:()=>Q,isIMG:()=>B,isInline:()=>q,isInlineBlock:()=>Y,isLiNode:()=>v,isNeutral:()=>x,isNoBreak:()=>z,isNoHanging:()=>V,isOBJECT:()=>F,isPRE:()=>X,isPageStartElement:()=>$,isSTYLE:()=>k,isSVG:()=>C,isSelectorMatching:()=>N,isSignificantTextNode:()=>y,isSlice:()=>j,isSlough:()=>te,isTableLikeNode:()=>Z,isTableNode:()=>J,isWrappedTextGroup:()=>A,isWrappedTextLine:()=>H,isWrappedTextNode:()=>L});var i={};e.r(i),e.d(i,{isFirstChildOfFirstChild:()=>oe,isLastChildOfLastChild:()=>ie,isLineChanged:()=>se,isLineKept:()=>re,resolveFlowElement:()=>ae,setInitStyle:()=>le});var s={};e.r(s),e.d(s,{getBottom:()=>pe,getBottomWithMargin:()=>ue,getContentHeightByProbe:()=>Se,getEmptyNodeHeight:()=>be,getHeightWithMargin:()=>_e,getLineHeight:()=>Me,getMaxWidth:()=>me,getNormalizedBottomWithMargin:()=>ge,getNormalizedTop:()=>ce,getTableEmptyRowHeight:()=>De,getTableEntries:()=>we,getTableRowHeight:()=>Oe,getTableRowShellHeightByTD:()=>Pe,getTop:()=>de,getTopWithMargin:()=>fe});var r={};e.r(r),e.d(r,{create:()=>Ee,createComplexTextBlock:()=>ve,createForcedPageBreak:()=>He,createNeutral:()=>Te,createNeutralBlock:()=>Ne,createPrintPageBreak:()=>Fe,createSignpost:()=>Ae,createTable:()=>$e,createTestNodeFrom:()=>xe,createTextGroup:()=>Be,createTextLine:()=>ke,createTextNodeWrapper:()=>ye,createWithFlagNoBreak:()=>Ce,createWord:()=>Le});var l={};e.r(l),e.d(l,{prepareSplittedNode:()=>Ge,splitByWordsGreedyWithSpacesFilter:()=>We,splitTextByLinesGreedy:()=>Re,splitTextByWordsGreedy:()=>Ie});var a={};e.r(a),e.d(a,{markPageStartElement:()=>qe,markPartNodesWithClass:()=>Ke,markProcessed:()=>ze,setFlagNoBreak:()=>Ve,setFlagNoHanging:()=>je,setFlagSlice:()=>Ue,unmarkPageStartElement:()=>Ye});var h={};e.r(h),e.d(h,{wrapNodeChildrenWithNeutralBlock:()=>Ze});var c={};e.r(c),e.d(c,{copyNodeWidth:()=>tt,fitElementWithinBoundaries:()=>Xe,fitElementWithinHeight:()=>Qe,lockTableWidths:()=>nt,scaleCellsToHeight:()=>et});var g={};e.r(g),e.d(g,{findAllForcedPageBreakInside:()=>rt,findBetterForcedPageStarter:()=>it,findBetterPageStart:()=>st,findFirstChildParent:()=>ht,findFirstChildParentFromPage:()=>lt,findLastChildParent:()=>ct,findPreviousNonHangingsFromPage:()=>at,findSuitableNonHangingPageStart:()=>gt});var d={};e.r(d),e.d(d,{getPreparedChildren:()=>pt,getSplitChildren:()=>ut});var p={};e.r(p),e.d(p,{isReplacedElement:()=>Ot,resolveReplacedElement:()=>Dt});var u={};e.r(u),e.d(u,{cloneAndCleanOutsideRange:()=>yt,getSplitPoints:()=>wt,getSplitPointsPerCells:()=>St,isFirstSliceEmpty:()=>Nt,sliceNodeBySplitPoints:()=>Et,sliceNodeContentBySplitPoints:()=>Tt});var _={};e.r(_),e.d(_,{shouldSkipFlowElement:()=>vt});const f={init:"[html2pdf]",pageDivider:"html2pdf-page",pageStartMarker:"[html2pdf-page-start]",contentFlowStart:"html2pdf-content-flow-start",contentFlowEnd:"html2pdf-content-flow-end",style:"[html2pdf-style]",footerTemplate:"[html2pdf-footer]",headerTemplate:"[html2pdf-header]",frontpageTemplate:"[html2pdf-frontpage]",frontpageContent:"html2pdf-frontpage",headerContent:"html2pdf-header",footerContent:"html2pdf-footer",pageNumberRoot:"[html2pdf-page-number]",pageNumberCurrent:"[html2pdf-page-number-current]",pageNumberTotal:"[html2pdf-page-number-total]",root:"html2pdf-root",paperFlow:"html2pdf-paper-flow",contentFlow:"html2pdf-content-flow",virtualPaper:"html2pdf-virtual-paper",virtualPaperTopMargin:"html2pdf-virtual-paper-margin-top",virtualPaperBottomMargin:"html2pdf-virtual-paper-margin-bottom",virtualPaperGap:"html2pdf-virtual-paper-gap",paperBody:"html2pdf-paper-body",paperHeader:"html2pdf-paper-header",paperFooter:"html2pdf-paper-footer",runningSafety:"html2pdf-print-running",printPageBreak:"html2pdf-print-page-break",printIgnore:"[html2pdf-print-ignore]",printHide:"[html2pdf-print-hide]",neutral:"html2pdf-neutral",word:"html2pdf-word",textNode:"html2pdf-text-node",textLine:"html2pdf-text-line",textGroup:"html2pdf-text-group",complexTextBlock:"html2pdf-complex-text-block",printForcedPageBreak:"html2pdf-print-forced-page-break",split:"[html2pdf-split]",processed:"[html2pdf-processed]",flagNoBreak:"[html2pdf-flag-no-break]",flagNoHanging:"[html2pdf-flag-no-hanging]",flagSlice:"[html2pdf-flag-slice]",topCutPart:".html2pdf-top-cut",bottomCutPart:".html2pdf-bottom-cut",tocPageNumber:"html2pdf-toc-page-number"};function m(e){let t={debugMode:!1,consoleAssert:!1,preloader:!1,preloaderTarget:"",preloaderBackground:"",mask:!0,noHangingSelectors:"",forcedPageBreakSelectors:"",pageBreakBeforeSelectors:"",pageBreakAfterSelectors:"",noBreakSelectors:"",tocPageNumberSelector:"html2pdf-toc-page-number",printLeftMargin:"21mm",printRightMargin:"21mm",printTopMargin:"12mm",printBottomMargin:"12mm",printFontSize:"12pt",printWidth:"210mm",printHeight:"297mm",headerMargin:"16px",footerMargin:"16px",virtualPagesGap:"16px",splitLabelHeight:"24px"};const n={printWidth:"210mm",printHeight:"297mm"},o={printWidth:"148.5mm",printHeight:"210mm"};switch((e=function(e){const t={...e};for(const e in t){const n=t[e];if("string"==typeof n){const o=n.toLowerCase();"true"===o||"1"===o?t[e]=!0:"false"!==o&&"0"!==o&&""!==o||(t[e]=!1)}}return t}(e)).printPaperSize){case"A5":case"a5":t={...t,...o};break;default:t={...t,...n}}t={...t,initialRoot:f.init,tocPageNumberSelector:f.tocPageNumber,...e},console.info("[HTML2PDF4DOC] Config:",t);const i={printLeftMargin:t.printLeftMargin,printRightMargin:t.printRightMargin,printTopMargin:t.printTopMargin,printBottomMargin:t.printBottomMargin,printFontSize:t.printFontSize,printWidth:t.printWidth,printHeight:t.printHeight,headerMargin:t.headerMargin,footerMargin:t.footerMargin,virtualPagesGap:t.virtualPagesGap},s=document.createElement("div");return s.style="\n  position:absolute;\n  z-index:1000;\n  left: 200%;\n  ",document.body.append(s),Object.entries(i).forEach((([e,t])=>{s.style.width=t,i[e]=`${Math.trunc(s.getBoundingClientRect().width)}px`})),s.remove(),t={...t,...i},t.noHangingSelectors=t.noHangingSelectors+" H1 H2 H3 H4 H5 H6",t.forcedPageBreakSelectors=t.forcedPageBreakSelectors+" "+f.printForcedPageBreak,t.debugMode&&console.info("Config with converted units:",t),t}const b={DOM:{_:!1},layout:{_:!0},pages:{_:!0,_parseNode:!0,_parseNodes:!0,_registerPageStart:!0},paper:{_:!1},preview:{_:!1},toc:{_:!1},node:{_:!0,children:!0,creators:!0,fitters:!0,getters:!0,markers:!0,pageBreaks:!0,positioning:!0,selectors:!0,slicers:!0,splitters:!0,flowFilters:!0,wrappers:!0},paragraph:{_:!0},grid:{_:!0},pre:{_:!0},table:{_:!0},tableLike:{_:!0}};class M{constructor({DOM:e,config:t}){this.document=e,this.body=e.body,this._debug=t.debugMode?{...t.debugConfig.DOM}:{},this._assert=!!t.consoleAssert}createElement(e){return this.document.createElement(e)}createDocumentFragment(){return this.document.createDocumentFragment()}cloneNode(e){return e?.cloneNode(!0)}cloneNodeWrapper(e){return e?.cloneNode(!1)}insertBefore(e,...t){const n=t.filter((e=>null!=e));e.before(...n)}insertAfter(e,...t){const n=t.filter((e=>null!=e));e.after(...n)}insertAtEnd(e,...t){const n=t.filter((e=>null!=e));e.append(...n)}insertAtStart(e,...t){const n=t.filter((e=>null!=e));e.prepend(...n)}insertInsteadOf(e,...t){this.insertBefore(e,...t),e.remove()}wrap(e,t){return e.before(t),t.append(e),t}moveContent(e,t){for(;e.firstChild;)t.append(e.firstChild);this._assert&&console.assert(""===this.getInnerHTML(e))}moveRowContent(e,t){if(!e||!t)return void(this._debug._&&console.warn("moveRowContent(): sourceTR or targetTR is missing"));const n=this.getElementTagName(e),o=this.getElementTagName(t);this._assert&&console.assert("TR"===n,`moveRowContent(): source is not TR, got ${n}`),this._assert&&console.assert("TR"===o,`moveRowContent(): target is not TR, got ${o}`);const i=[...this.getChildren(e)],s=[...this.getChildren(t)];i.length!==s.length&&this._debug._&&console.warn(`moveRowContent(): cells count mismatch: ${i.length} (source) vs ${s.length} (target)`);const r=Math.min(i.length,s.length);for(let e=0;e<r;e++)this.moveContent(i[e],s[e])}replaceNodeContentsWith(e,...t){this.setInnerHTML(e,""),this.insertAtEnd(e,...t)}removeNode(e){e.remove()}getAll(e,t=this.document){return this._assert&&console.assert(e),"string"==typeof e&&(e=e.split(",").filter(Boolean)),this._assert&&console.assert(Array.isArray(e),"Selectors must be provided as an array or string (one selector or multiple selectors, separated by commas). Now the selectors are:",e),this._assert&&console.assert(e.length>0,"getAll(selectors), selectors:",e),1===e.length?[...this.getAllElements(e[0],t)]:[...e].flatMap((e=>[...this.getAllElements(e,t)]))}getElement(e,t=this.document){return this._assert&&console.assert(e),t.querySelector(e)}getAllElements(e,t=this.document){return this._assert&&console.assert(e),t.querySelectorAll(e)}getElementById(e,t=this.document){return t.getElementById(e)}getRightNeighbor(e){return e.nextElementSibling}getLeftNeighbor(e){return e.previousElementSibling}getParentNode(e){return e.parentElement}getNodeValue(e){return e.nodeValue}getLastElementChild(e){return e.lastElementChild}getFirstElementChild(e){return e.firstElementChild}getChildNodes(e){return e.childNodes}getChildren(e){return e.children}getElementOffsetParent(e){return e.offsetParent}getComputedStyle(e){return window.getComputedStyle(e)}getElementBCR(e){return e.getBoundingClientRect()}getElementOffsetLeft(e){return e?.offsetLeft}getElementOffsetHeight(e){return e?.offsetHeight}getElementOffsetWidth(e){return e?.offsetWidth}getElementOffsetTop(e){return e?.offsetTop}getElementOffsetBottom(e){return e?.offsetTop+e?.offsetHeight||void 0}getElementTagName(e){return e.tagName}getDataId(e){return e.dataset.id}getAttribute(e,t){if(!e||!t)return void(this._debug._&&console.warn("getAttribute() must have 2 params"));const n=t.charAt(0);if("."!==n&&"#"!==n||this._debug._&&console.log(`you're really sure ${t} is attribute selector?`),"["===n){this._assert&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const n=t.substring(1,t.length-1);return e.getAttribute(n)}e.getAttribute(t)}setAttribute(e,t,n){if(!e||!t)return void(this._debug._&&console.warn("setAttribute() must have 2 params"));const o=t.charAt(0);if("."!==o)if("#"!==o)if("["!==o)this._debug._&&console.log(`you're really sure ${t} is a selector?`);else{this._assert&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const o=t.substring(1,t.length-1);e.setAttribute(o,n||"")}else{const n=t.substring(1);e.id=n}else{const n=t.substring(1);e.classList.add(n)}}setStyles(e,t){Object.entries(t).forEach((([t,n])=>e.style[t]=n))}addClasses(e,...t){e.classList.add(...t)}removeAttribute(e,t){if(!e||!t)return void(this._debug._&&console.warn("removeAttribute() must have 2 params"));const n=t.charAt(0);if(this._assert&&console.assert(n.match(/[a-zA-Z#\[\.]/),`removeAttribute() expects a valid selector, but received ${t}`),"."!==n)if("#"!==n)if("["!==n)e.removeAttribute(attr);else{this._assert&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const n=t.substring(1,t.length-1);e.removeAttribute(n)}else{const n=t.substring(1);e.removeAttribute(n)}else{const n=t.substring(1);e.classList.remove(n)}}removeAllAttributes(e){for(;e.attributes.length>0;)e.removeAttribute(e.attributes[0].name)}removeClasses(e,...t){e.classList.remove(...t)}removeAllClasses(e){e.classList=""}removeAllStyles(e){e.style=""}getInnerHTML(e){if("string"==typeof e){const t=this.document.querySelector(e);return t?t.innerHTML:void 0}return e.innerHTML}setInnerHTML(e,t){if("string"==typeof e){const n=this.document.querySelector(e);n&&(n.innerHTML=t)}e.innerHTML=t}isDocumentBody(e){return"BODY"===e.tagName}isTextNode(e){return e.nodeType===Node.TEXT_NODE}isElementNode(e){return e.nodeType===Node.ELEMENT_NODE}hasClass(e,t){return e.classList.contains(t)}hasID(e,t){return e.id===t}hasAttribute(e,t){return e.hasAttribute(t)}}class O{constructor(e){this.config=e,this.charWidth="10px"}create(){return this._baseStyle()+this._testStyle()}_baseStyle(){return`\n\n@page {\n  size: A4;\n  /* 2 values: width then height */\n  size: ${this.config.printWidth} ${this.config.printHeight};\n\n  margin-left: ${this.config.printLeftMargin};\n  margin-right: ${this.config.printRightMargin};\n  margin-top: ${this.config.printTopMargin};\n  margin-bottom: 0; /* hack */\n}\n\n${f.root} {\n  /* reset user styles */\n  display: block;\n\n  /* for proper printable flow positioning */\n  position: relative;\n\n  /* to compensate for possible BG in the parent node */\n  z-index: 1;\n\n  /* set print styles: affects previews */\n  margin: 0 auto;\n  width: calc(${this.config.printWidth} - ${this.config.printLeftMargin} - ${this.config.printRightMargin});\n  font-size: ${this.config.printFontSize};\n\n  /* protection against unpredictability of margins */\n  padding-top: .1px;\n  padding-bottom: calc(2 * ${this.config.virtualPagesGap});\n}\n\n${f.contentFlowStart},\n${f.contentFlowEnd},\n${f.pageDivider} {\n  display: block;\n  /* to avoid the effect of margins of neighboring elements on the positioning of this marker: */\n  overflow: auto;\n}\n\n${f.virtualPaper} {\n  display: grid;\n  grid-template-columns: 1fr;\n  grid-template-rows: minmax(min-content, max-content) minmax(min-content, max-content) 1fr minmax(min-content, max-content) minmax(min-content, max-content);\n  place-items: stretch stretch;\n  place-content: stretch stretch;\n  width: calc(${this.config.printWidth} - ${this.config.printLeftMargin} - ${this.config.printRightMargin});\n  height: ${this.config.printHeight};\n  font-size: ${this.config.printFontSize};\n}\n\n${f.virtualPaper}::before {\n  position: absolute;\n  content: '';\n  width: ${this.config.printWidth};\n  height: ${this.config.printHeight};\n  left: -${this.config.printLeftMargin};\n  background-color: #fff;\n  box-shadow: rgba(0, 0, 0, 0.1) 2px 2px 12px 0px;\n  z-index: -1;\n}\n\n${f.paperFooter},\n${f.paperHeader} {\n  display: block;\n  position: relative;\n}\n\n${f.headerContent},\n${f.footerContent} {\n  display: block;\n  font-size: small;\n}\n\n${f.headerContent} p,\n${f.footerContent} p {\n  margin: 0;\n}\n\n${f.headerContent} {\n  padding-bottom: ${this.config.headerMargin};\n  /* padding-top: 1px; */\n  /* Page numbers: */\n  padding-top: 10px;\n}\n\n${f.footerContent} {\n  padding-top: ${this.config.footerMargin};\n  /* padding-bottom: 1px; */\n  /* Page numbers: */\n  min-height: 32px;\n}\n\n${f.tocPageNumber} {\n  min-width: 3ch;\n  display: flex;\n  justify-content: flex-end;\n  align-items: baseline;\n}\n\n${f.pageNumberRoot} {\n  display: flex;\n  column-gap: 2px;\n  position: absolute;\n  /* left: 100%; */\n  right: 0;\n  text-align: right;\n  line-height: 1;\n}\n\n${f.headerContent} ${f.pageNumberRoot} {\n  top: 0;\n}\n\n${f.footerContent} ${f.pageNumberRoot} {\n  bottom: 0;\n}\n\n${f.paperFlow} {\n  display: block;\n  position: absolute;\n  width: 100%;\n  z-index: -1;\n  /* affect only screen */\n  padding-bottom: 100px;\n}\n\n${f.contentFlow} {\n  display: block;\n}\n\n${f.runningSafety} {\n  display: block;\n  overflow: auto;\n}\n\n${f.virtualPaperTopMargin} {\n  display: block;\n  height: ${this.config.printTopMargin};\n}\n\n${f.virtualPaperBottomMargin} {\n  display: block;\n  height: ${this.config.printBottomMargin};\n}\n\n${f.virtualPaperGap} {\n  display: block;\n  padding-top: ${this.config.virtualPagesGap};\n}\n\n${f.paperBody} {\n  display: block;\n}\n\n${f.frontpageContent} {\n  display: block;\n  transform-origin: top center;\n  padding: .1px;\n  height: 100%;\n}\n\n.null {\n  display: inline;\n  padding: 0;\n  margin: 0;\n  font: 0;\n  color: transparent;\n  line-height: 0;\n  border: none;\n  outline: none;\n  background: none;\n  background-color: transparent;\n}\n\n${f.word},\n${f.textNode},\n${f.textLine},\n${f.textGroup},\n${f.neutral},\n${f.neutral} span {\n  display: inline;\n  padding: 0;\n  margin: 0;\n  font: inherit;\n  color: inherit;\n  line-height: inherit;\n  background: none;\n  background-color: transparent;\n}\n\n${f.textGroup} {\n  display: block;\n}\n\n/*${f.split} ${f.textGroup} {\n  display: inline;\n}*/\n\n${f.complexTextBlock} > ${f.textLine} {\n  /* Firefox and inconsistent values of offset top for inline element */\n  display: inline-block;\n  // TODO: it removes spaces between parts of the string, it should leave the text inline after processing.\n}\n\n${f.textGroup} ${f.textLine} {\n  display: inline;\n}\n\n${f.complexTextBlock} {\n  display: block;\n}\n\n${f.complexTextBlock} ${f.complexTextBlock} {\n  display: inline;\n}\n\n${f.printPageBreak} {\n  display: block;\n}\n\n${f.printForcedPageBreak} {\n  display: block;\n  visibility: hidden;\n  height: 0;\n  overflow: hidden;\n}\n\n@media print {\n  ${f.root} {\n    /* to prevent a blank last page */\n    padding: 0;\n  }\n\n  ${f.paperFlow} {\n    padding-bottom: 0;\n  }\n\n  ${f.contentFlow} {\n    -webkit-mask-image: none !important;\n            mask-image: none !important;\n  }\n\n  ${f.printIgnore} {\n    display: contents;\n  }\n\n  ${f.printHide},\n  ${f.virtualPaper}::before,\n  ${f.virtualPaperTopMargin},\n  ${f.virtualPaperBottomMargin},\n  ${f.virtualPaperGap} {\n    display: none;\n  }\n\n  ${f.virtualPaper} {\n    break-inside: avoid;\n    height: auto;\n  }\n\n  ${f.paperBody} {\n    break-inside: avoid;\n  }\n\n  ${f.printPageBreak} {\n    break-after: page;\n    /* padding: .1px; */\n    overflow: auto;\n  }\n\n  ${f.printForcedPageBreak} {\n    /* JUST MANUAL! */\n    /* break-after: page; */\n  }\n\n  ${f.flagNoBreak} {\n    /*\n    TODO: temporary commented!\n    When splitting blocks, printPageBreak falls INTO this element,\n    and in Firefox it causes a blank page.\n    FIX the split of complex blocks and check in Firefox.\n    */\n    /* break-inside: avoid-page; */\n  }\n}\n\n/* arrangement */\n${f.topCutPart} {\n  margin-top: 0 !important;\n  border-top: none !important;\n}\n${f.bottomCutPart} {\n  margin-bottom: 0 !important;\n  border-bottom: none !important;\n}\n    `}_testStyle(){return this.config.debugMode?`\n/* FOR TEST */\n${f.contentFlow} {\n  background:repeating-linear-gradient(\n    -45deg,\n    rgba(222, 222, 222, .1),\n    rgba(222, 222, 222, .1) 10px,\n    rgba(222, 222, 222, .2) 10px,\n    rgba(222, 222, 222, .2) 20px\n  );\n}\n\n${f.virtualPaperGap} {\n  background: #ff000020;\n}\n\n${f.paperFooter},\n${f.paperHeader} {\n  background: #fa96ff20;\n}\n${f.paperBody} {\n  background: #ffee0020;\n}\n${f.runningSafety} {\n  background: #f200ff;\n  outline: 0.1px solid #f200ff88;\n}\n${f.frontpageContent} {\n  background: #00fcff20;\n}\n\n${f.neutral} {\n  background: #00ffee10;\n}\n\n${f.textNode} {\n  background: #00ff0010;\n}\n\n${f.textGroup},\n${f.textLine} {\n  background: #0000ff08;\n}\n\n    `:""}}class D{constructor({config:e,DOM:t,node:n,selector:o}){this.success=!1,this.root,this.paperFlow,this.contentFlow,this.frontpageTemplate,this.headerTemplate,this.footerTemplate,this._initialRoot,this._contentRoot,this._config=e,this._debug=e.debugMode?{...e.debugConfig.layout}:{},this._assert=!!e.consoleAssert,this._DOM=t,this._selector=o,this._node=n,this._customInitialRootSelector=e.initialRoot,this._defaultInitialRootSelector=o.init}create(){if(this._getTemplates(),this._insertStyle(),this._DOM.getElement(`style${this._selector.style}`)){if(this._createLayout(),this._DOM.getParentNode(this.root)!==this._initialRoot||this._DOM.getElementOffsetParent(this.paperFlow)!==this.root||this._DOM.getElementOffsetParent(this.contentFlow)!==this.root)return this._assert&&console.assert(this._DOM.getParentNode(this.root)===this._initialRoot,"Failed to insert the layout root into the DOM."),this._assert&&console.assert(this._DOM.getElementOffsetParent(this.paperFlow)===this.root,"Failed to insert the paperFlow element into the DOM."),void(this._assert&&console.assert(this._DOM.getElementOffsetParent(this.contentFlow)===this.root,"Failed to insert the contentFlow element into the DOM."));this.success=!0}else console.error("Failed to add print styles into the DOM.")}_getTemplates(){this._assert&&console.assert(this._selector.frontpageTemplate,"frontpageTemplate selector is missing"),this._assert&&console.assert(this._selector.headerTemplate,"headerTemplate selector is missing"),this._assert&&console.assert(this._selector.footerTemplate,"footerTemplate selector is missing"),this.frontpageTemplate=this._DOM.getInnerHTML(this._selector.frontpageTemplate),this.headerTemplate=this._DOM.getInnerHTML(this._selector.headerTemplate),this.footerTemplate=this._DOM.getInnerHTML(this._selector.footerTemplate)}_insertStyle(){const e=this._DOM.getElement("head"),t=this._DOM.body;if(!e&&!t)return void console.error("Check the structure of your document. We didn`t find HEAD and BODY tags. HTML2PDF4DOC expects valid HTML.");const n=this._node.create("style",new O(this._config).create());n?(this._DOM.setAttribute(n,this._selector.style,""),e?this._DOM.insertAtEnd(e,n):t?this._DOM.insertBefore(t,n):this._assert&&console.assert(!1,"We expected to find the HEAD and BODY tags.")):console.error("Failed to create print styles")}_createLayout(){this._getInitialRoot(),this._initialRoot?(this._debug._&&console.log("initial root:",this._initialRoot),this._createRoot(),this._createPaperFlow(),this._createContentFlow(),this._DOM.moveContent(this._initialRoot,this.contentFlow),this._DOM.insertAtEnd(this._initialRoot,this.root),this._DOM.insertAtEnd(this.root,this.paperFlow,this.contentFlow),this._insertContentFlowStartAndEnd(this.contentFlow),this._ignoreUnprintableEnvironment(this.root)):console.error("Failed to initialize the root element.")}_insertContentFlowStartAndEnd(e){const t=this._node.create(this._selector.contentFlowStart),n=this._node.create(this._selector.contentFlowEnd);return this._DOM.insertAtStart(e,t),this._DOM.insertAtEnd(e,n),{contentFlowStart:t,contentFlowEnd:n}}_getInitialRoot(){let e=this._customInitialRootSelector?this._DOM.getElement(this._customInitialRootSelector):this._DOM.getElement(this._defaultInitialRootSelector);if(!e){if(!this._DOM.body)return void console.error("We expected to find the BODY tag.");e=this._DOM.body,console.warn(`The printable area is currently unspecified and encompasses the entire contents of the BODY tag. To restrict the printed content to a specific area, include ${this._defaultInitialRootSelector} in the root element of the desired printing area.`)}return this._initialRoot=e,e}_createRoot(){const e=this._node.create(this._selector.root);return this.root=e,e}_createPaperFlow(){const e=this._node.create(this._selector.paperFlow);return this.paperFlow=e,e}_createContentFlow(){const e=this._node.create(this._selector.contentFlow);return this.contentFlow=e,e}_ignoreUnprintableEnvironment(e){if(e===this._DOM.body)return void(this._assert&&console.assert(!1,"misshapen root"));let t=this._DOM.getParentNode(e);this._DOM.setAttribute(t,this._selector.printIgnore),this._DOM.getChildNodes(t).forEach((t=>{if(t!==e&&this._DOM.isElementNode(t))this._DOM.setAttribute(t,this._selector.printHide);else{if(!this._node.isSignificantTextNode(t))return;{const e=this._node.createTextNodeWrapper();this._DOM.wrap(t,e),this._DOM.setAttribute(e,this._selector.printHide)}}})),this._DOM.isDocumentBody(t)||this._ignoreUnprintableEnvironment(t)}}const P="background:#eee;color:#888;padding: 0 1px 0 0;";function w(e,t="",n=!1){"boolean"==typeof t&&(n=t,t=""),!0===n?this._debug._&&console.groupCollapsed(`%c${e}`,t):this._debug._&&console.group(`%c${e}`,t)}function S(e){this._debug._&&console.log(`%c ▲ ${e} `,P),this._debug._&&console.groupEnd()}function E(e){return function(t){return t._config.debugMode&&t._debug[e]}}const T=E("selectors");function N(e,t){if(!e||!t)return void(T(this)&&console.warn("isSelectorMatching() must have 2 params","\n element: ",e,"\n selector: ",t));const n=t.charAt(0);if("."===n){const n=t.substring(1);return this._DOM.hasClass(e,n)}if("#"===n){const n=t.substring(1);return this._DOM.hasID(e,n)}if("["===n){T(this)&&console.assert("]"===t.at(-1),`the ${t} selector is not OK.`);const n=t.substring(1,t.length-1);return this._DOM.hasAttribute(e,n)}return this._DOM.getElementTagName(e)===t.toUpperCase()}function y(e){return!!this._DOM.isTextNode(e)&&this._DOM.getNodeValue(e).trim().length>0}function k(e){return"STYLE"===this._DOM.getElementTagName(e)}function B(e){return"IMG"===this._DOM.getElementTagName(e)}function C(e){return"svg"===this._DOM.getElementTagName(e)}function F(e){return"OBJECT"===this._DOM.getElementTagName(e)}function v(e){return"LI"===this._DOM.getElementTagName(e)}function x(e){return this.isSelectorMatching(e,this._selector.neutral)}function L(e){return this.isSelectorMatching(e,this._selector.textNode)}function H(e){return this.isSelectorMatching(e,this._selector.textLine)}function A(e){return this.isSelectorMatching(e,this._selector.textGroup)}function $(e){return this.isSelectorMatching(e,this._selector.pageStartMarker)}function R(e){return this.isSelectorMatching(e,this._selector.contentFlowStart)}function I(e){const t=this._DOM.getLeftNeighbor(e);return this.isSelectorMatching(t,this._selector.contentFlowStart)}function W(e){return this.isSelectorMatching(e,this._selector.contentFlowEnd)}function G(e){return this.isSelectorMatching(e,this._selector.complexTextBlock)}function z(e,t=this._DOM.getComputedStyle(e)){return this.isSelectorMatching(e,this._selector.flagNoBreak)||this.isWrappedTextLine(e)||this.isWrappedTextGroup(e)||this.isInlineBlock(t)||this.notSolved(e)}function V(e){return this.isSelectorMatching(e,this._selector.flagNoHanging)}function j(e){return this.isSelectorMatching(e,this._selector.flagSlice)}function U(e){return this.isSelectorMatching(e,this._selector.printForcedPageBreak)}function q(e){const t=e.display;return"inline"===t||"inline-block"===t||"inline-table"===t||"inline-flex"===t||"inline-grid"===t}function Y(e){const t=e.display;return"inline-block"===t||"inline-table"===t||"inline-flex"===t||"inline-grid"===t}function K(e){return"grid"===e.display}function Z(e,t=this._DOM.getComputedStyle(e)){return"TABLE"!==this._DOM.getElementTagName(e)&&["table"].includes(t.display)}function J(e,t=this._DOM.getComputedStyle(e)){return"TABLE"===this._DOM.getElementTagName(e)||["table"].includes(t.display)}function X(e,t=this._DOM.getComputedStyle(e)){return["block"].includes(t.display)&&["pre","pre-wrap","pre-line","break-spaces","nowrap"].includes(t.whiteSpace)}function Q(e){const t=e.display,n=e.gridAutoFlow;return("grid"===t||"inline-grid"===t)&&"row"===n}function ee(e){const t=this._DOM.getComputedStyle(e);return this.isPRE(e,t)||this.isTableNode(e,t)||this.isTableLikeNode(e,t)||this.isGridAutoFlowRow(t)}function te(e){return this._DOM.hasAttribute(e,"slough-node")}const ne=E("positioning");function oe(e,t){if(!e||!this._DOM.getParentNode(e))return!1;let n=e;for(;this._DOM.getParentNode(n)&&n!==t;){if(this._DOM.getFirstElementChild(this._DOM.getParentNode(n))!==n)return!1;n=this._DOM.getParentNode(n)}return n===t}function ie(e,t){if(!e||!this._DOM.getParentNode(e))return!1;let n=e;for(;this._DOM.getParentNode(n)&&n!==t;){if(this._DOM.getParentNode(n)===t){let e=this._DOM.getRightNeighbor(n);for(;!this._DOM.getElementOffsetHeight(e)&&!this._DOM.getElementOffsetWidth(e);)if(e=this._DOM.getRightNeighbor(e),this.isContentFlowEnd(e))return!0;return this.isContentFlowEnd(e)}if(this._DOM.getLastElementChild(this._DOM.getParentNode(n))!==n)return!1;n=this._DOM.getParentNode(n)}return n===t}function se(e,t){return this._DOM.getElementOffsetTop(t)-this._DOM.getElementOffsetBottom(e)>-2}function re(e,t){const n=this._DOM.getElementOffsetBottom(e),o=this._DOM.getElementOffsetTop(t),i=n-o,s=i>=2;return ne(this)&&console.group("isLineKept?"),ne(this)&&console.log("\n",s,"\n","\n currentBottom",n,[e],"\n nextTop",o,[t],"\n delta",i),ne(this)&&console.groupEnd("isLineKept?"),s}function le(e,t,n){const o="[init-position]",i="[init-vertical-align]",s="relative",r=n||this._DOM.getComputedStyle(t),l=r.position,a=r.verticalAlign;if(e)l!=s&&(this._DOM.setStyles(t,{position:s}),this._DOM.setAttribute(t,o,l)),"top"!=a&&(this._DOM.setStyles(t,{"vertical-align":"top"}),this._DOM.setAttribute(t,i,a));else{const e=this._DOM.getAttribute(t,o),n=this._DOM.getAttribute(t,i);e&&(this._DOM.setStyles(t,{position:e}),this._DOM.removeAttribute(t,o)),n&&(this._DOM.setStyles(t,{"vertical-align":n}),this._DOM.removeAttribute(t,i))}}function ae(e,{prefer:t="self"}={}){if(!e)return null;const n=e=>"last"===t?this._DOM.getLastElementChild(e):"first"===t||"self"===t?this._DOM.getFirstElementChild(e):null,o=new Set;let i=e;for(;i&&!o.has(i);){o.add(i);if(this._DOM.getElementOffsetParent(i))return i;const e=this._DOM.getComputedStyle(i);if(!e)return null;const t=e.display,s=e.visibility,r=e.position;if("none"===t||"collapse"===s||"fixed"===r)return null;if("contents"!==t)return null;{const e=n.call(this,i);if(!e)return null;i=e}}return null}const he=E("getters");function ce(e,t,n){const o=n||this._DOM.getComputedStyle(t),i=parseFloat(o.paddingTop)||0;return this.getTop(e,t)-i}function ge(e,t,n){const o=n||this._DOM.getComputedStyle(t),i=parseFloat(o.paddingTop)||0;return this.getBottomWithMargin(e,t)-i}function de(e,t=null,n=0){if(!e)return void(he(this)&&console.warn("element must be provided, but was received:",e,"\nThe function returned:",void 0));if(null===t)return this._DOM.getElementOffsetTop(e);if(!t)return void(he(this)&&console.warn("root must be provided, but was received:",t,"\nThe function returned:",void 0));const o=this._DOM.getElementOffsetParent(e);if(!o)return void(he(this)&&console.warn("Element has no offset parent.","\n element:",[e],"\n offsetParent:",o,"\n The function returned:",void 0));const i=this._DOM.getElementOffsetTop(e);return o===t?i+n:this.getTop(o,t,n+i)}function pe(e,t=null){if(e){if(null===t)return this._DOM.getElementOffsetBottom(e);if(t)return this.getTop(e,t)+this._DOM.getElementOffsetHeight(e);he(this)&&console.warn("root must be provided, but was received:",t,"\nThe function returned:",void 0)}else he(this)&&console.warn("element must be provided, but was received:",e,"\nThe function returned:",void 0)}function ue(e,t){if(!e)return;const n=this.getBottom(e,t);let o;const i=this.createNeutralBlock();this._DOM.insertAfter(e,i);const s=this.getTop(i,t);this._DOM.removeNode(i);if(s>=n)o=s;else{o=n+parseInt(this._DOM.getComputedStyle(e).marginBottom)}return o}function _e(e){const t=parseInt(this._DOM.getComputedStyle(e).marginTop),n=parseInt(this._DOM.getComputedStyle(e).marginBottom);return this._DOM.getElementOffsetHeight(e)+t+n}function fe(e,t){const n=parseInt(this._DOM.getComputedStyle(e).marginTop);return this.getTop(e,t)-n}function me(e){const t=this.create();this._DOM.insertAtEnd(e,t);const n=this._DOM.getElementOffsetWidth(t);return this._DOM.removeNode(t),n}function be(e,t="",n=!0){const o=this.create();n&&this._DOM.setStyles(o,{overflow:"auto"});const i=this._DOM.cloneNodeWrapper(e);this._DOM.setInnerHTML(i,t),this._DOM.insertAtEnd(o,i),this._DOM.insertBefore(e,o);const s=this._DOM.getElementOffsetHeight(o);return this._DOM.removeNode(o),s}function Me(e){const t=this.createNeutral();this._DOM.setInnerHTML(t,"!"),this._DOM.setStyles(t,{display:"block"}),this._DOM.insertAtEnd(e,t);const n=this._DOM.getElementOffsetHeight(t);return this._DOM.removeNode(t),n}function Oe(e,t=0){const n=this._DOM.getElementOffsetTop(e),o=this._DOM.cloneNode(e),i="!<br />".repeat(t);[...o.children].forEach((e=>this._DOM.setInnerHTML(e,i))),this._DOM.insertBefore(e,o);const s=this._DOM.getElementOffsetTop(e);return this._DOM.removeNode(o),s-n}function De(e){const t=this._DOM.getElementOffsetTop(e),n=this._DOM.cloneNodeWrapper(e);this._DOM.insertBefore(e,n);const o=this._DOM.getElementOffsetTop(e);return this._DOM.removeNode(n),o-t}function Pe(e){const t=this._DOM.getElementOffsetTop(e),n=this._DOM.cloneNodeWrapper(e),o=e.children.length,i=[...e.children];this._DOM.insertBefore(e,n);const s=[];for(let r=0;r<o;r++){const l=[];for(let e=0;e<o;e++){let t;e===r?(t=this._DOM.cloneNodeWrapper(i[e]),this._DOM.setInnerHTML(t,"")):(t=document.createElement("td"),this._DOM.setInnerHTML(t,""),this._DOM.setStyles(t,{padding:"0",border:"none",verticalAlign:"top",lineHeight:"0",minHeight:"0",fontSize:"0"})),l.push(t)}this._DOM.insertAtEnd(n,...l);const a=this._DOM.getElementOffsetTop(e)-t;s.push(a),l.forEach((e=>this._DOM.removeNode(e)))}return this._DOM.removeNode(n),s}function we(e){if(!(e instanceof HTMLElement)||"TABLE"!==e.tagName)throw new Error("Expected a <table> element.");const t=[...e.children].reduce(((e,t)=>{const n=t.tagName;return"TBODY"===n?{...e,rows:[...e.rows,...t.children]}:"CAPTION"===n?(this.setFlagNoBreak(t),{...e,caption:t}):"COLGROUP"===n?(this.setFlagNoBreak(t),{...e,colgroup:t}):"THEAD"===n?(this.setFlagNoBreak(t),{...e,thead:t}):"TFOOT"===n?(this.setFlagNoBreak(t),{...e,tfoot:t}):"TR"===n?{...e,rows:[...e.rows,...t]}:(he(this)&&t&&console.warn("unexpected:",t),{...e,unexpected:[...e.unexpected,...t]})}),{caption:null,thead:null,tfoot:null,rows:[],unexpected:[]});return t.unexpected.length>0&&he(this)&&console.warn(`something unexpected is found in the table ${e}`),t}function Se(e,t){const n=t||this._DOM.getComputedStyle(e),o=this.createNeutralBlock();this._DOM.setStyles(o,{display:"block",padding:"0",margin:"0",border:"0",height:"0",clear:"both",visibility:"hidden",contain:"layout"}),this._DOM.insertAtEnd(e,o);const i=this.getNormalizedTop(o,e,n);return this._DOM.removeNode(o),i}E("creators");function Ee(e,t){let n;if(e){const t=e.charAt(0);if(t.match(/[#\[\.]/))n=this._DOM.createElement("div"),this._DOM.setAttribute(n,e);else{if(!t.match(/[a-zA-Z]/))return void(this._assert&&console.assert(!1,"Expected valid html selector ot tag name, but received:",e));n=this._DOM.createElement(e)}}else n=this._DOM.createElement("div");return t&&this._DOM.setInnerHTML(n,t),n}function Te(){return this.create(this._selector.neutral)}function Ne(){const e=this.createNeutral();return e.style.display="block",e.style.clear="both",e}function ye(){return this.create(this._selector.textNode)}function ke(){return this.create(this._selector.textLine)}function Be(){return this.create(this._selector.textGroup)}function Ce(e){const t=this.create(this._selector.flagNoBreak);return e&&this._DOM.setStyles(t,e),t}function Fe(){return this.create(this._selector.printPageBreak)}function ve(){return this.create(this._selector.complexTextBlock)}function xe(e){const t=this._DOM.cloneNodeWrapper(e);return this._DOM.setAttribute(t,".test-node"),this._DOM.setStyles(t,{position:"absolute",background:"rgb(255 239 177)",width:this.getMaxWidth(e)+"px"}),t}function Le(e,t){const n=this.create(this._selector.word);return this._DOM.setInnerHTML(n,e),n.dataset.index=t,n}function He(){return console.log("%c createForcedPageBreak","background:cyan"),this.create(this._selector.printForcedPageBreak)}function Ae(e,t){if(!t)return null;const n=this.create();return this._DOM.setStyles(n,{display:"flex",flexWrap:"nowrap",alignItems:"center",justifyContent:"center",textAlign:"center",fontSize:"8px",fontFamily:"sans-serif",letterSpacing:"1px",textTransform:"uppercase",height:t+"px"}),e&&this._DOM.setInnerHTML(n,e),n}function $e({wrapper:e,caption:t,colgroup:n,thead:o,tfoot:i,tbody:s}){const r=e||this.create("table"),l=this.create("TBODY");return t&&this._DOM.insertAtEnd(r,t),n&&this._DOM.insertAtEnd(r,n),o&&this._DOM.insertAtEnd(r,o),s&&this._DOM.insertAtEnd(l,...s),this._DOM.insertAtEnd(r,l),i&&this._DOM.insertAtEnd(r,i),r}E("splitters");function Re(e){return e.split(/(?<=\n)/)}function Ie(e){return(this._DOM.getNodeValue(e)||this._DOM.getInnerHTML(e)).split(/(?<=\s|-)/)}function We(e){return(this._DOM.getNodeValue(e)||this._DOM.getInnerHTML(e)).trim().split(/(?<=\s|-)/).filter((e=>" "!=e))}function Ge(e){const t=e,n=this.splitTextByWordsGreedy(e),o=n.map((e=>{const t=this._DOM.createElement("span");return this._DOM.setInnerHTML(t,e+" "),t})),i=this.createTestNodeFrom(e);return this._DOM.insertAtEnd(i,...o),this._DOM.insertAtEnd(e,i),{splittedNode:t,nodeWords:n,nodeWordItems:o}}E("markers");function ze(e,t){this._markupDebugMode&&this._DOM.setAttribute(e,this._selector.processed,"🏷️ "+t)}function Ve(e){this._DOM.setAttribute(e,this._selector.flagNoBreak)}function je(e,t){this._DOM.setAttribute(e,this._selector.flagNoHanging,t)}function Ue(e){this._DOM.setAttribute(e,this._selector.flagSlice)}function qe(e,t){this._DOM.setAttribute(e,this._selector.pageStartMarker,t)}function Ye(e){this._DOM.removeAttribute(e,this._selector.pageStartMarker)}function Ke(e){e.forEach((e=>{this._DOM.setAttribute(e,this._selector.topCutPart),this._DOM.setAttribute(e,this._selector.bottomCutPart)})),this._DOM.removeAttribute(e.at(0),this._selector.topCutPart),this._DOM.removeAttribute(e.at(-1),this._selector.bottomCutPart)}E("wrappers");function Ze(e){const t=this._DOM.getChildren(e),n=this.createNeutralBlock();return this._DOM.insertAtStart(n,...t),this._DOM.insertAtStart(e,n),n}const Je=E("fitters");function Xe({element:e,height:t,width:n,vspace:o,hspace:i}){const s=o/t,r=i/n,l=s<r?s:r,a=Math.trunc(t*l),h=Math.trunc(n*l);this._DOM.setStyles(e,{height:a+"px",width:h+"px"}),this._DOM.setAttribute(e,"height",`${a}px`),this._DOM.setAttribute(e,"width",`${h}px`)}function Qe(e,t){const n=this._DOM.getElementOffsetHeight(e);if(n<=t)return;const o=t/n;e.style.transformOrigin="top left",e.style.transform=`scale(${o})`;const i=this.createNeutral();i.style.display="inline-block",i.style.verticalAlign="top",i.style.width="100%",i.style.height=t+"px",this._DOM.wrap(e,i),Je(this)&&console.warn(`%c Scaled element to fit target height: ${t}px`,"color:orange; font-weight:bold;",`scale: ${o}`,e)}function et(e,t,n){const o=Array.isArray(n)?n:new Array(e.length).fill(0);let i=!1;for(let n=0;n<e.length;n++){const s=e[n],r=o[n]||0,l=Math.max(0,t-r);if(l<=0)continue;const a=1===this._DOM.getChildren(s).length,h=this._DOM.getFirstElementChild(s);let c,g=null;a&&h&&this.isNeutral(h)?(g=h,c=this._DOM.getElementOffsetHeight(g)):c=this.getContentHeightByProbe(s),c>l&&(g||(g=this.wrapNodeChildrenWithNeutralBlock(s)),this.fitElementWithinHeight(g,l),i=!0,Je(this)&&console.warn("💢 scaleCellsToHeight: resized cell content",{cell:s,target:l}))}return i}function tt(e,t){this._DOM.setStyles(e,{"box-sizing":"border-box",width:`${this._DOM.getElementOffsetWidth(t)}px`,"min-width":`${this._DOM.getElementOffsetWidth(t)}px`})}function nt(e){this.copyNodeWidth(e,e),this._DOM.getAll("td",e).forEach((e=>this.copyNodeWidth(e,e)))}const ot=E("pageBreaks");function it(e,t){let n=e;for(;;){const e=this.findFirstChildParent(n,t);if(e&&e!==n){n=e;continue}let o=this._DOM.getLeftNeighbor(n);for(;o&&this.shouldSkipFlowElement(o,{context:"findBetterForcedPageStarter:left"});)o=this._DOM.getLeftNeighbor(o);if(!o||!this.isNoHanging(o))break;n=o}return n}function st(e,t,n){ot(this)&&console.group("➗ findBetterPageStart");let o=!1,i=!1;const s=this.getTop(t,n);ot(this)&&console.log("Start calculations:",{pageStart:e,lastPageStart:t,root:n,topLimit:s});const r=this.findFirstChildParentFromPage(e,s,n);let l;if(r)l=r;else{l=this.getTop(e,n)<s?t:e}ot(this)&&console.log("betterCandidate:",l);let a=l;for(;;){const e=this.findPreviousNonHangingsFromPage(a,s,n);if(void 0===e){ot(this)&&console.warn("🫥 previousCandidate",e),o=!0;break}if(ot(this)&&console.log("• previousCandidate",{previousCandidate:e}),e){a=e;continue}ot(this)&&console.log("• update currentCandidate",{previousCandidate:e});const t=this.findFirstChildParentFromPage(a,s,n);if(void 0===t){ot(this)&&console.warn("🫥 firstChildParent",t),o=!0;break}if(ot(this)&&console.log("• firstChildParent",{firstChildParent:t}),!t){ot(this)&&console.log("• update currentCandidate",{firstChildParent:t});break}a=t}(a==t||this.getTop(a,n)<s)&&(i=!0,ot(this)&&console.log("☝️ Top page limit has been reached",a));let h=this._DOM.getLeftNeighbor(a);for(;h&&this.shouldSkipFlowElement(h,{context:"findBetterPageStart:leftCheck"});)h=this._DOM.getLeftNeighbor(h);h==t&&(i=!0,ot(this)&&console.log("👈 Left limit has been reached (left neighbor is the last page start)",h,l));let c=o||i?l:a;if(this.getTop(c,n)<s&&(c=t),this.isAfterContentFlowStart(c)&&(c=e),this.shouldSkipFlowElement(c,{context:"findBetterPageStart:result"})){let e=t;if(l!==c){const t=this.shouldSkipFlowElement(l,{context:"findBetterPageStart:fallback"})?null:l;t&&(e=t)}c=e}return ot(this)&&console.log({interruptedWithUndefined:o,interruptedWithLimit:i,pageStart:e,betterCandidate:l,currentCandidate:a,result:c}),ot(this)&&console.log("➗ end, return:",c),ot(this)&&console.groupEnd(),c}function rt(e){return this._DOM.getAll(this._selector.printForcedPageBreak,e)}function lt(e,t,n){ot(this)&&console.group("⬆ findFirstChildParentFromPage"),ot(this)&&console.log({element:e,topLimit:t,root:n});let o=null,i=e,s=!1;for(;;){let e=this._DOM.getParentNode(i);for(;e&&this.shouldSkipFlowElement(e,{context:"findFirstChildParentFromPage:parent"});)e=this._DOM.getParentNode(e);if(!e||e===n)break;let r=this._DOM.getFirstElementChild(e);for(;r&&this.shouldSkipFlowElement(r,{context:"findFirstChildParentFromPage:firstChild"});)r=this._DOM.getRightNeighbor(r);if(!r){i=e;continue}if(!(r===i)){ot(this)&&console.log("parent is NOT the First Child",{parent:e});break}const l=this.resolveFlowElement(e,{prefer:"first"});if(!l){i=e;continue}const a=this.isPageStartElement(e)||this.isPageStartElement(l),h=this.getTop(l,n);if(a||h<t){ot(this)&&console.warn("🫥 findFirstChildParentFromPage // interruptedByPageStart"),s=!0;break}ot(this)&&console.log({parent:e}),o=l,i=e}return ot(this)&&console.groupEnd("⬆ findFirstChildParentFromPage"),s?void 0:o}function at(e,t,n){ot(this)&&console.group("⬅ findPreviousNonHangingsFromPage");let o=null,i=e,s=!1;for(;;){let e=this._DOM.getLeftNeighbor(i);for(;e&&this.shouldSkipFlowElement(e,{context:"findPreviousNonHangingsFromPage:left"});)e=this._DOM.getLeftNeighbor(e);if(ot(this)&&console.log({interruptedByPageStart:s,topLimit:t,prev:e,current:i}),!e||e===i)break;if(!this.isNoHanging(e))break;let r=this.resolveFlowElement(e,{prefer:"last"});if(!r){i=e;continue}for(;r&&this.shouldSkipFlowElement(r,{context:"findPreviousNonHangingsFromPage:flow"});)r=this.resolveFlowElement(this._DOM.getLeftNeighbor(r),{prefer:"last"});if(!r){i=e;continue}const l=this.isPageStartElement(e)||this.isPageStartElement(r),a=this.getTop(r,n);if(l||a<t){s=!0;break}o=r,i=r}return ot(this)&&console.groupEnd("⬅ findPreviousNonHangingsFromPage"),s?void 0:o}function ht(e,t){let n=this._DOM.getParentNode(e),o=null;for(;n&&n!==t&&n!==t;){for(;n&&this.shouldSkipFlowElement(n,{context:"findFirstChildParent:parent"});)n=this._DOM.getParentNode(n);if(!n||n===t)break;let i=this._DOM.getFirstElementChild(n);for(;i&&this.shouldSkipFlowElement(i,{context:"findFirstChildParent:firstChild"});)i=this._DOM.getRightNeighbor(i);if(i){if(e!==i)return o;o=n,e=n,n=this._DOM.getParentNode(e)}else n=this._DOM.getParentNode(n)}return o}function ct(e,t){let n=this._DOM.getParentNode(e),o=null;for(;n&&n!==t&&n!==t;){for(;n&&this.shouldSkipFlowElement(n,{context:"findLastChildParent:parent"});)n=this._DOM.getParentNode(n);if(!n||n===t)break;let i=this._DOM.getLastElementChild(n);for(;i&&this.shouldSkipFlowElement(i,{context:"findLastChildParent:lastChild"});)i=this._DOM.getLeftNeighbor(i);if(i){if(e!==i)return o;o=n,e=n,n=this._DOM.getParentNode(e)}else n=this._DOM.getParentNode(n)}return o}function gt(e,t){let n=e,o=null;for(;;){let e=this._DOM.getLastElementChild(n);for(;e&&this.shouldSkipFlowElement(e,{context:"findSuitableNonHangingPageStart:descend"});)e=this._DOM.getLeftNeighbor(e);if(!e)break;if(this.isNoHanging(e)){o=e;break}n=e}if(o)for(n=o;n&&n!==e;){let t=this._DOM.getParentNode(n);for(;t&&this.shouldSkipFlowElement(t,{context:"findSuitableNonHangingPageStart:ascend"});)t=this._DOM.getParentNode(t);if(!t||t===e)break;let i=this._DOM.getFirstElementChild(t);for(;i&&this.shouldSkipFlowElement(i,{context:"findSuitableNonHangingPageStart:ascendFirst"});)i=this._DOM.getRightNeighbor(i);if(!i||i!==n)break;o=t,n=t}else o=e;return this.getTop(o)>t?o:null}const dt=E("children");function pt(e){dt(this)&&console.group("getPreparedChildren of",e);let t=[];return this.isComplexTextBlock(e)?(t=[...this._DOM.getChildren(e)],dt(this)&&console.info("🚸 getPreparedChildren: return children for complexTextBlock",t)):(t=[...this._DOM.getChildNodes(e)].reduce(((e,t)=>{if(this.isSTYLE(t))return dt(this)&&console.info("🚸 (getPreparedChildren) ignore STYLE",[t]),e;if(this.isSignificantTextNode(t)){const n=this.createTextNodeWrapper();return this._DOM.wrap(t,n),e.push(n),dt(this)&&console.info("🚸 (getPreparedChildren) wrap and return TEXT NODE",[t]),e}if(this._DOM.isElementNode(t)){if(this.shouldSkipFlowElement(t,{context:"getPreparedChildren"}))return e;if(!this._DOM.getElementOffsetParent(t)){const n=this.getPreparedChildren(t);return n.length>0&&e.push(...n),dt(this)&&console.info("%c🚸 (getPreparedChildren) * no offset parent — unwrapped","color:green",n,[t]),e}return e.push(t),dt(this)&&console.info("🚸 (getPreparedChildren) * normal node",[t]),e}return dt(this)&&console.info("%c🚸 (getPreparedChildren) IGNORE whitespace / comment ...","color:red",[t]),e}),[]),ft.call(this,t)&&(dt(this)&&console.info("🚸 (getPreparedChildren) isVerticalFlowDisrupted in children of",[e]),t=_t.call(this,t))),dt(this)&&console.groupEnd("getPreparedChildren"),dt(this)&&console.info("🚸 getPreparedChildren:",t),t}function ut(e,t,n,o){let i=[];if(this.isNoBreak(e))return dt(this)&&console.info("🧡 isNoBreak",e),[];if(this.isComplexTextBlock(e))return dt(this)&&console.info("💚 ComplexTextBlock",e),this._paragraph.split(e)||[];if(this.isWrappedTextNode(e))return dt(this)&&console.info("💚 TextNode",e),this._paragraph.split(e)||[];const s=this._DOM.getComputedStyle(e);return this.isTableLikeNode(e,s)?(dt(this)&&console.info("💚 TABLE like",e),i=this._tableLike.split(e,t,n,o,s)||[]):this.isTableNode(e,s)?(dt(this)&&console.info("💚 TABLE",e),i=this._table.split(e,t,n,o)||[]):this.isPRE(e,s)?(dt(this)&&console.info("💚 PRE",e),i=this._pre.split(e,t,n,o)||[]):this.isGridAutoFlowRow(this._DOM.getComputedStyle(e))?(dt(this)&&console.info("💜 GRID"),i=this._grid.split(e,t,n,o)||[]):(dt(this)&&console.info("💚 found some node - use main this.getPreparedChildren() for:",e),i=this.getPreparedChildren(e)),i}function _t(e){let t=null;const n=[];return e.forEach((e=>{this.isInline(this._DOM.getComputedStyle(e))?(t||(t=this.createComplexTextBlock(),this._DOM.wrap(e,t),n.push(t)),this._DOM.insertAtEnd(t,e)):(t=null,n.push(e))})),n}function ft(e){return e.some(((e,t,n)=>{const o=e,i=n[t+1];if(!i)return!1;return this._DOM.getElementOffsetBottom(o)>this._DOM.getElementOffsetTop(i)}))}const mt=E("media"),bt=new Set(["IMG","SVG","OBJECT","EMBED","IFRAME","VIDEO","AUDIO","CANVAS"]);function Mt(e,t="self"){return"last"===t?this._DOM.getLastElementChild(e):this._DOM.getFirstElementChild(e)}function Ot(e){if(!e)return!1;const t=this._DOM.getElementTagName(e);if(!t)return!1;if("INPUT"===t){return"image"===(this._DOM.getAttribute(e,"type")||"").toLowerCase()}return bt.has(t)}function Dt(e,{prefer:t="self"}={}){if(!e)return null;const n=new Set;let o=e;for(;o&&!n.has(o);){if(n.add(o),this.isReplacedElement(o))return o;if("function"==typeof this.resolveFlowElement){const e=this.resolveFlowElement(o,{prefer:t});if(e&&e!==o){if(this.isReplacedElement(e))return e;o=e;continue}}const e=[...this._DOM.getChildren(o)].filter((e=>{const t=this._DOM.getComputedStyle(e)?.display;return"none"!==t}));if(1!==e.length)return mt(this)&&console.info("🧭 resolveReplacedElement: branching or empty wrapper",o,e),null;o=Mt.call(this,o,t)||e[0]}return null}const Pt=E("slicers");function wt({rootNode:e,rootComputedStyle:t,children:n,firstPartHeight:o,fullPageHeight:i,points:s=[]}){const r=t=>{const o=this.findBetterPageStart(t,s.at(-1),e,e);return!s.length&&o===n[0]&&n[1]?(Pt(this)&&console.log("%c !points.length && point === children[0] && children[1]","color:red"),Pt(this)&&console.log("%c 🅾️ push(null) in registerPoint()","color:red"),s.push(null),!0):(s.push(o),!1)};Pt(this)&&console.group("🧶 getSplitPoints"),Pt(this)&&console.log("points.length",s.length);const l=t||this._DOM.getComputedStyle(e);this.setInitStyle(!0,e,l),Pt(this)&&console.group(`walking through ${n.length} children`,n);for(let t=0;t<n.length;t++){const a=n[t],h=n[t-1],c=n[t+1];Pt(this)&&console.log({currentElement:a,previousElement:h,nextElement:c});const g=c?this.getNormalizedTop(c,e,l):void 0;let d,p;if(0===s.length?(d=o,p=o):null===s.at(-1)?(d=i,p=i):(d=this.getNormalizedTop(s.at(-1),e,l)+i,p=i),this.isForcedPageBreak(a)&&(r(a),Pt(this)&&console.warn("🍎",[a],"isForcedPageBreak")),g<=d)Pt(this)&&console.log(`current fits: (next top) ${g} <= ${d} (floater)`,[a]);else{(this.isSVG(a)||this.isIMG(a))&&Pt(this)&&console.log("%cIMAGE","color:red;text-weight:bold");const t=this.getNormalizedBottomWithMargin(a,e,l);if(Pt(this)&&console.log(`current does not fit: (next top) ${g} > ${d} (floater)`,[a]),Pt(this)&&console.log(`? (curr bottom) ${t} // ${d} (floater)`,[a]),t<=d)Pt(this)&&console.log(`(curr bottom) ${t} <= ${d} (floater)`,[a]),c?(Pt(this)&&console.log("🍎 register nextElement as Point:",[c]),r(c)):Pt(this)&&console.log("=== this is the end of element list ///");else{Pt(this)&&console.log(`current does NOT fit (curr bottom) ${t} > ${d} (floater)`,[a],"🍎 try to split it");let h=[];const g=this.getSplitChildren(a,o,i,e);if(g.length){if(h=wt.call(this,{rootNode:e,rootComputedStyle:l,children:g,firstPartHeight:o,fullPageHeight:i,points:s}),0===h.length){const e=Math.max(o,i),t=this._DOM.getElementOffsetHeight(a),l=t>e&&(!h.length||1===h.length&&null===h[0]);if(Pt(this)&&console.log("room (Math.max)",e),l){if(Pt(this)&&console.warn("%c⚠️ UNSPLITTABLE OVERSIZED ELEMENT — SCALE IT","color:white; background:red; font-weight:bold;",a,`height: ${t}`),!s.length&&a===n[0])return Pt(this)&&console.warn("🅾️ (1) points.push(null) in isUnbreakableOversized"),s.push(null),s;if(c){if(r(c))return s}}else if(r(a))return s}}else{Pt(this)&&console.log("🍎 currentElementChildren.length == 0");const e=this._DOM.getElementOffsetHeight(a);if(e>p&&(!h.length||1===h.length&&null===h[0])){if(Pt(this)&&console.warn("%c⚠️ UNSPLITTABLE OVERSIZED ELEMENT — SCALE IT","color:white; background:red; font-weight:bold;",a,`height: ${e}`),Pt(this)&&console.warn("🅾️ (2) points.push(null) in isUnbreakableOversized"),!s.length&&a===n[0])return s.push(null),s;c&&(console.warn("🅾️🅾️🅾️🅾️🅾️🅾️🅾️🅾️ registerPoint(nextElement)"),r(c))}else if(r(a))return s}}}}return Pt(this)&&console.groupEnd(`walking through ${n.length} children`),this.setInitStyle(!1,e,t),Pt(this)&&console.groupEnd("getSplitPoints"),s}function St(e,t,n,o,i){Pt(this)&&console.group("[✖️] getSplitPointsPerCells");const s=e.map(((e,s)=>{Pt(this)&&console.group(`(•) Split CELL.${s} in:`,i);const r=n-(t[s]||0),l=o-(t[s]||0),a=this.getSplitChildren(e,r,l,i),h=this.getSplitPoints({rootNode:e,children:a,firstPartHeight:r,fullPageHeight:l});return Pt(this)&&console.log(`(•) return splitPoints for CELL#${s}`,h),Pt(this)&&console.groupEnd(),h})),r=s.some(Nt);let l=s,a=!1;if(r){l=e.map(((e,s)=>{Pt(this)&&console.group(`(••) Split CELL.${s} in:`,i);const r=n-(t[s]||0),l=o-(t[s]||0),a=this.getSplitChildren(e,r,l,i),h=this.getSplitPoints({rootNode:e,children:a,firstPartHeight:l,fullPageHeight:l});return Pt(this)&&console.log(`(••) return splitPoints for CELL#${s}`,h),Pt(this)&&console.groupEnd(),h})),Pt(this)&&console.log("[••] splitPointsPerCell",l);for(let e=0;e<l.length;e++){const t=l[e];Nt(t)&&1===t.length&&(l[e]=[],a=!0)}}return Pt(this)&&console.groupEnd("[✖️] getSplitPointsPerCells"),{splitPointsPerCell:l,isFirstPartEmptyInAnyCell:r,needsScalingInFullPage:a}}function Et({index:e,rootNode:t,splitPoints:n}){Pt(this)&&console.group(`🔪 (${e}) sliceNodeBySplitPoints`,n);const o=[];this._assert&&(n.length>0&&console.assert(n.every((e=>null!==e)),"sliceNodeBySplitPoints: splitPoints contains null — sanitize upstream before slicing"),console.assert(n.every((e=>!e||e.nodeType===Node.ELEMENT_NODE&&(t===e||t.contains(e)))),"sliceNodeBySplitPoints: split point is not an Element within rootNode"));for(let e=0;e<=n.length;e++){const i=n[e-1]??null,s=n[e]??null,r=this.cloneAndCleanOutsideRange(t,i,s);r.childNodes.length>0&&o.push(r)}return Pt(this)&&console.log(o),Pt(this)&&console.groupEnd(`🔪 (${e}) sliceNodeBySplitPoints`),o}function Tt({index:e,rootNode:t,splitPoints:n}){Pt(this)&&console.group(`🔪 (${e}) sliceNodeContentBySplitPoints`);const o=[];for(let e=0;e<=n.length;e++){const i=n[e-1]??null,s=n[e]??null,r=this.cloneAndCleanOutsideRange(t,i,s);Pt(this)&&console.log({slice:r});const l=this.createNeutralBlock();for(;r.firstChild;)l.appendChild(r.firstChild);l.childNodes.length>0&&o.push(l)}return Pt(this)&&console.log(o),Pt(this)&&console.groupEnd(`🔪 (${e}) sliceNodeContentBySplitPoints`),o}function Nt(e){return Array.isArray(e)&&e.length>0&&null===e[0]}function yt(e,t,n){t&&t.setAttribute("split","start"),n&&n.setAttribute("split","end");let o=e.cloneNode(!0);if(t){let t=o.querySelector('[split="start"]'),n=t.previousElementSibling;for(;n;){let e=n;n=n.previousElementSibling,e.remove()}let i=t.parentElement;for(;i&&i!==e;){let e=i.previousElementSibling;for(;e;){let t=e;e=e.previousElementSibling,t.remove()}i=i.parentElement}t.removeAttribute("split")}if(n){let t=o.querySelector('[split="end"]'),n=t.nextElementSibling;for(;n;){let e=n;n=n.nextElementSibling,e.remove()}let i=t.parentElement;for(;i&&i!==e;){let e=i.nextElementSibling;for(;e;){let t=e;e=e.nextElementSibling,t.remove()}i=i.parentElement}t.remove()}return t&&t.removeAttribute("split"),n&&n.removeAttribute("split"),o}const kt=E("flowfilters"),Bt="__html2pdfFlowFilter",Ct=[{test:e=>"none"===e.display,cache:{reason:"display:none",message:"* display:none — skipped"}},{test:e=>"absolute"===e.position,cache:{reason:"position:absolute",message:"* position:absolute — skipped"}},{test:e=>"fixed"===e.position,cache:{reason:"position:fixed",message:"* position:fixed — skipped"}},{test:e=>"collapse"===e.visibility,cache:{reason:"visibility:collapse",message:"* visibility:collapse — skipped"}}];function Ft(e,t,n,o,{cached:i}={cached:!1}){if(!kt(e))return;const s=t?`(${t}) `:"",r=i?" (cached)":"";console.info(`🚸 ${s}${n.message}${r}`,[o])}function vt(e,{context:t="",computedStyle:n}={}){if(!(e&&this&&this._DOM&&this._DOM.isElementNode(e)))return!1;const o=e[Bt];if(o)return Ft(this,t,o,e,{cached:!0}),!0;const i=n??this._DOM.getComputedStyle(e);if(!i)return!1;for(const n of Ct)if(n.test(i))return e[Bt]=n.cache,Ft(this,t,n.cache,e),!0;return!1}class xt{constructor({config:e,DOM:t,node:o,selector:i}){this._debug=e.debugMode?{...e.debugConfig.paragraph}:{},this._DOM=t,this._selector=i,this._node=o,this._minParagraphLeftLines=2,this._minParagraphDanglingLines=2,this._minParagraphBreakableLines=this._minParagraphLeftLines+this._minParagraphDanglingLines||2,Object.assign(this,n)}split(e){return this._splitComplexTextBlockIntoLines(e)}_estimateLineCount(e){return Math.ceil(this._DOM.getElementOffsetHeight(e)/this._node.getLineHeight(e))}_splitComplexTextBlockIntoLines(e){if(this._debug._&&console.group("_splitComplexTextBlockIntoLines",[e]),this._estimateLineCount(e)<this._minParagraphBreakableLines)return this.logGroupEnd("few lines - Not to break it up"),[];if(this._node.isSelectorMatching(e,this._selector.split))return this.logGroupEnd(this._selector.split),this._DOM.getChildren(e);const t=this._node.getPreparedChildren(e),n=t.map((e=>{const t=this._node.getLineHeight(e),n=this._DOM.getElementOffsetHeight(e),o=this._DOM.getElementOffsetLeft(e),i=this._DOM.getElementOffsetTop(e);return{element:e,lines:Math.ceil(n/t),left:o,top:i,height:n,lineHeight:t,text:this._DOM.getInnerHTML(e)}}));this._debug._&&console.log("\n🚸 nodeChildren",[...t],"\n🚸 extendedChildrenArray",[...n]);const o=n.flatMap((e=>e.lines>1&&!this._node.isNoBreak(e.element)?this._breakItIntoLines(e.element):e.element));this._debug._&&console.log("\n🚸🚸🚸\n partiallyLinedChildren",[...o]);const i=o.reduce(((e,t,n,o)=>(e||(e=[]),"BR"===this._DOM.getElementTagName(t)?(e.at(-1).push(t),e.push([]),this._debug._&&console.log("br; push:",t),e):!e.length||this._node.isLineChanged(e.at(-1).at(-1),t)?(e.push([t]),this._debug._&&console.log("◼️ start new line:",t),e):0===e.at(-1).length||e.length&&this._node.isLineKept(e.at(-1).at(-1),t)?(this._debug._&&console.log("⬆ add to line:",t),e.at(-1).push(t),e):void(this._debug._&&console.assert(!0,"groupedPartiallyLinedChildren: An unexpected case of splitting a complex paragraph into lines.","\nOn the element:",t)))),[]);if(this._debug._&&console.log("🟡🟡🟡 groupedPartiallyLinedChildren \n",i.length,[...i]),i.length<this._minParagraphBreakableLines)return this._debug._&&console.log("groupedPartiallyLinedChildren.length < this._minParagraphBreakableLines",i.length,"<",this._minParagraphBreakableLines),this.logGroupEnd("NOT _splitComplexTextBlockIntoLines"),[];const s=i.slice(0,this._minParagraphLeftLines).flat(),r=i.slice(-this._minParagraphDanglingLines).flat();this._debug._&&console.log("groupedPartiallyLinedChildren",[...i],"\n","minLeftLines =",this._minParagraphLeftLines,"\n",s,"\n","minDanglingLines =",this._minParagraphDanglingLines,"\n",r),i.splice(0,this._minParagraphLeftLines,s),i.splice(-this._minParagraphDanglingLines,this._minParagraphDanglingLines,r);const l=i.map(((e,t)=>{let n;if(0==e.length)n=e[0],n.setAttribute("role","🚫"),console.assert(0==e.length,"The string cannot be empty (_splitComplexTextBlockIntoLines)");else if(1==e.length)n=e[0];else{n=this._node.createTextGroup(),this._DOM.insertBefore(e[0],n),this._DOM.insertAtEnd(n,...e)}return n.dataset.child=t,n}));return this.logGroupEnd("OK _splitComplexTextBlockIntoLines"),this._DOM.setAttribute(e,this._selector.split),l}_breakItIntoLines(e){if(this._debug._&&console.group("_breakItIntoLines",[e]),this._node.isNoBreak(e))return this.logGroupEnd("isNoBreak"),e;if(this._node.isWrappedTextNode(e)){const t=this._breakWrappedTextNodeIntoLines(e);return this.logGroupEnd("TextNode newLines"),t}return this.logGroupEnd("(recursive _breakItIntoLines)"),this._processNestedInlineElements(e)}_processNestedInlineElements(e){this._debug._&&console.group("_processNestedInlineElements",[e]);const t=this._getNestedInlineChildren(e).flatMap((e=>this._estimateLineCount(e)>1?this._breakItIntoLines(e):e)),n=this._findNewLineStarts(t),o=n.map(((o,i)=>{const s=t[o],r=t[n[i+1]];return this._node.cloneAndCleanOutsideRange(e,s,r)}));return this._DOM.insertInsteadOf(e,...o),this.logGroupEnd("Nested Inline parts"),o}_getNestedInlineChildren(e){return[...this._DOM.getChildNodes(e)].reduce(((e,t)=>{if(this._node.isSignificantTextNode(t)){const n=this._node.createTextNodeWrapper();return this._DOM.wrap(t,n),e.push(n),e}if(!this._DOM.getElementOffsetParent(t)){const n=this._node.getPreparedChildren(t);return n.length>0&&e.push(...n),e}if(this._DOM.isElementNode(t)){return this._getNestedInlineChildren(t).forEach((t=>e.push(t))),e}}),[])}_makeWordsFromTextNode(e){const t=this._node.splitTextByWordsGreedy(e);this._debug._&&console.log("wordArray",t);const n=t.map(((e,t)=>this._node.createWord(e+"",t)));return this._debug._&&console.log("wrappedWordArray",n),{wordArray:t,wrappedWordArray:n}}_breakWrappedTextNodeIntoLines(e){e.classList.add("🔠_breakItIntoLines");const{wordArray:t,wrappedWordArray:n}=this._makeWordsFromTextNode(e);this._DOM.setInnerHTML(e,""),this._DOM.insertAtEnd(e,...n);const o=this._findNewLineStarts(n),i=o.reduce(((n,i,s)=>{const r=this._node.createTextLine(),l=o[s],a=o[s+1],h=t.slice(l,a).join("")+"";return this._DOM.setInnerHTML(r,h),this._DOM.insertBefore(e,r),n.push(r),n}),[]);return e.remove(),i}_findNewLineStarts(e){return e.reduce(((t,n,o)=>(o>0&&e[o-1].offsetTop+e[o-1].offsetHeight<=n.offsetTop&&t.push(o),t)),[0])}}function Lt(e){if(e)return"function"==typeof e.getDebug?e.getDebug():e.debug}function Ht(e,t,n="unknown case"){if(!e||"function"!=typeof e.getSplitBottom||"function"!=typeof e.setSplitBottom)throw new Error("updateSplitBottom: adapter must expose getSplitBottom() and setSplitBottom().");const o=e.getSplitBottom();let i;if("number"==typeof t)i=t;else{if(!(t instanceof HTMLElement))throw new Error("updateSplitBottom: unexpected value type: "+typeof t);if("function"!=typeof e.computeSplitBottomForElement)throw new Error("updateSplitBottom: adapter must implement computeSplitBottomForElement(element).");i=e.computeSplitBottomForElement(t)}e.setSplitBottom(i);const s=function(e){return e?"function"==typeof e.getSplitBottomLog?e.getSplitBottomLog():e.splitBottomLog||null:null}(e);Array.isArray(s)&&s.push(i);const r=Lt(e);r&&r._&&console.log(`%c♻️ [${function(e){return e?.label||"element"}(e)}] update splitBottom (with ${t}) \n • ${n}`,"color: green; font-weight: bold","\n",o,"->",i,s?`\n log: ${s}`:"")}function At(e,t,n,o="register page start"){const i=function(e){return e?"function"==typeof e.getRows?e.getRows()||[]:e.rows||[]:[]}(e),s=i.length,r=function(e){return!!e&&("function"==typeof e.shouldAssert?e.shouldAssert():Boolean(e.assert))}(e),l=Lt(e),a=Number.isInteger(t);if(r&&console.assert(a,`registerPageStartAt: index must be an integer, got: ${t}`),!a)return;if(r&&console.assert(s>0,"registerPageStartAt: no rows to register"),0===s)return;if(0===t)return l&&l._&&console.log("%c 📍 Row #0 forced to next page (no short first fragment)","color:green; font-weight:bold"),void((i[0]instanceof HTMLElement||"number"==typeof i[0])&&Ht(e,i[0],`${o} (index=0)`));let h=Math.max(1,Math.min(t,s-1));const c=n.at(-1);if(null!=c&&h<=c&&(h=c+1),h>=s)return void(r&&console.assert(!1,`registerPageStartAt: computed index (${h}) >= rowsLen (${s})`));n.push(h),l&&l._&&console.log(`%c 📍 Row # ${h} registered as page start`,"color:green; font-weight:bold");const g=i[h];(g instanceof HTMLElement||"number"==typeof g)&&Ht(e,g,o)}function $t(e){return e._node.createSignpost("(table continued)",e._signpostHeight)}class Rt{constructor({config:e,DOM:t,node:o,selector:i}){this._debug=e.debugMode?{...e.debugConfig.table}:{},this._assert=!!e.consoleAssert,this._DOM=t,this._selector=i,this._node=o,this._splitLabelHeightFromConfig=e.splitLabelHeight,this._initConstants(),Object.assign(this,n),this._resetCurrent()}split(e,t,n,o){this._setCurrent(e,t,n,o);const i=this._splitCurrentTable();return this._resetCurrent(),i}_initConstants(){this._signpostHeight=parseFloat(this._splitLabelHeightFromConfig)||0,this._minPartLines=2}_resetCurrent(){this._currentTable=void 0,this._currentFirstPageBottom=void 0,this._currentFullPageHeight=void 0,this._currentRoot=void 0,this._currentTableEntries=void 0,this._currentTableDistributedRows=void 0,this._currentTableFirstPartContentBottom=void 0,this._currentTableFullPartContentHeight=void 0,this._currentTableTfootHeight=void 0,this._currentTableSplitBottom=void 0,this._logSplitBottom_=[],this._currentRowShellCache=void 0,this._currentTableHasRowspan=void 0,this._currentTableHasColspan=void 0,this._currentTableInconsistentCells=void 0,this._currentTableHasUnexpectedChildren=void 0}_setCurrent(e,t,n,o){this._currentTable=e,this._currentFirstPageBottom=t,this._currentFullPageHeight=n,this._currentRoot=o,this._currentRowShellCache=new WeakMap}_prepareCurrentTableForSplitting(){this._lockCurrentTableWidths(),this._collectCurrentTableEntries(),this._updateCurrentTableDistributedRows(),this._analyzeCurrentTableStructure(),this._collectCurrentTableMetrics()}_lockCurrentTableWidths(){this._node.lockTableWidths(this._currentTable)}_splitCurrentTable(){this._prepareCurrentTableForSplitting(),this._setCurrentTableFirstSplitBottom(),this._debug._&&console.group("%c📊 _splitCurrentTable()","color:green; background:#eee; padding:3px","\n•",this._currentTableFirstPartContentBottom,"(1st bottom)","\n•",this._currentTableFullPartContentHeight,"(full part height)",{table:this._currentTable,rows:this._currentTableDistributedRows,entries:this._currentTableEntries,root:this._currentRoot});let e=[];for(let t=0;t<this._currentTableDistributedRows.length;t++)t=this._evaluateRowForSplitting(t,e);if(this._debug._&&console.log("\n splitStartRowIndexes",e,"\n Distributed Rows",[...this._currentTableDistributedRows]),this._assert&&console.assert(e.every((e=>Number.isInteger(e)&&e>0&&e<=this._currentTableDistributedRows.length)),"splitStartRowIndexes contains invalid indexes"),this._assert&&console.assert(e.every(((e,t,n)=>0===t||e>n[t-1])),"splitStartRowIndexes must be strictly ascending and without duplicates"),this._assert&&console.assert(e.at(-1)!==this._currentTableDistributedRows.length,"Last split index should not equal rows.length, or the original table will be empty."),!e.length)return this.logGroupEnd("_splitCurrentTable !splitStartRowIndexes.length"),[];const t=e.map(((e,t,n)=>{const o=t>0?n[t-1]:0;return this._createAndInsertTableSlice({startId:o,endId:e,table:this._currentTable,tableEntries:this._currentTableEntries})})),n=this._createAndInsertTableFinalSlice({table:this._currentTable});return this._debug._&&console.log("splits",t),this._debug._&&console.log("lastPart",n),this.logGroupEnd("_splitCurrentTable"),[...t,n]}_evaluateRowForSplitting(e,t){const n=e,o=this._currentTableDistributedRows.length;this._debug._&&console.group(`🔲 %c Check the Row # ${n} (from ${o})`,"");const i=this._currentTableDistributedRows[e];this._debug._&&console.info({row:i,rows:[...this._currentTableDistributedRows]});const s=this._getRowFitDelta(e);if(s<=0)this._debug._&&console.log(`%c ✓ Row # ${e}: PASS`,"color:green");else{const r=!this._currentTableDistributedRows[e+1],l=this._getFinalPartReclaimedHeight();if(r){const t=this._node.getBottom(i,this._currentTable),s=t-this._currentTableSplitBottom;if(this._debug._&&console.log("🫟 last-row-extra-check",{overflow:s,extraCapacity:l,currRowBottom:t,splitBottom:this._currentTableSplitBottom}),s<=l)return this._debug._&&console.log("🫟 last-row-fits-without-bottom-signpost: skip split"),this.logGroupEnd(`Row # ${n} (from ${o}) is checked`),e}const a=this._node.isSlice(i);if(this._rowHasSpan(i)){this._debug._&&console.log("%c ⚠️ Row has ROWSPAN; use conservative fallback (no slicing)","color:DarkOrange; font-weight:bold");const s=this._node.getTop(i,this._currentTable),r=this._currentTableSplitBottom-s;return e=this._handleRowOverflow(e,i,r,this._currentTableFullPartContentHeight,t,"Row with ROWSPAN — move to next page","Row with ROWSPAN — scaled TDs to full page"),this._debug._&&r>=this._currentTableFullPartContentHeight&&console.warn("[table.fallback] ROWSPAN row required full-page scaling to fit."),this.logGroupEnd(`Row # ${n} (from ${o}) is checked`),e}if(a){this._debug._&&a&&console.log(`%c Row # ${e} is slice! but don't fit`,"color:DarkOrange; font-weight:bold",i),this._debug._&&console.warn("%c SUPER BIG","background:red;color:white",s,{part:this._currentTableFullPartContentHeight});const n=this._node.getTop(i,this._currentTable),o=this._currentTableSplitBottom-n;e=this._handleRowOverflow(e,i,o,this._currentTableFullPartContentHeight,t,"Slice doesn't fit tail — move to next page","Scaled TD content to fit full page")}else{this._debug._&&console.group(`%c 🔳 Try to split the ROW ${e} %c (from ${this._currentTableDistributedRows.length})`,"color:magenta;","");const n=this._node.getTableRowHeight(i,this._minPartLines),o=this._node.getTop(i,this._currentTable);this._assert&&console.assert(this._currentTableSplitBottom>=o,`It seems that the previous row will not fit into the page (it crosses the slice line): split bottom (${this._currentTableSplitBottom}) < currRowTop ${o}`);const s=this._currentTableSplitBottom-o;let h=s,c=!1;s<n&&(this._debug._&&console.log(`%c ${s} < ${n} %c (remainingPageSpace < _minMeaningfulRowSpace) → use full-page budget for the first part`,"color:red; font-weight:bold; background:#F1E9D2",""),h=this._currentTableFullPartContentHeight,c=!0),this._debug._&&console.info({currRowTop:o,"• splitBottom":this._currentTableSplitBottom,"• is row sliced?":!a,"remaining page space":s,"first part height":h,"full part height":this._currentTableFullPartContentHeight});const{newRows:g,isFirstPartEmptyInAnyTD:d,needsScalingInFullPage:p}=this._splitTableRow(e,i,h,this._currentTableFullPartContentHeight);if(this._debug._&&console.log("%c newRows \n","color:magenta; font-weight:bold",g),g.length){if(this._replaceRowInDOM(i,g),r){this._debug._&&console.log("🫟 Tail drop");this._DOM.getElementOffsetHeight(g.at(-1))<=l&&(this._DOM.moveRowContent(g.at(-1),g.at(-2)),this._DOM.removeNode(g.at(-1)),g.pop())}this._updateCurrentTableEntriesAfterSplit(e,g),this._updateCurrentTableDistributedRows();if(d||c)p&&g[0]&&(this._debug._&&console.log("⚖️ _scaleProblematicTDs"),this._scaleProblematicTDs(g[0],this._currentTableFullPartContentHeight,this._getRowShellHeights(g[0]))),this._registerPageStartAt(e,t,"Empty first part — move row to next page");else{const n=g[0],o=this._node.getTop(n,this._currentTable),i=this._currentTableSplitBottom-o;i>0&&this._scaleProblematicTDs(n,i,this._getRowShellHeights(n)),this._registerPageStartAt(e+1,t,"Row split — next slice starts new page")}e-=1}else{this._debug._&&console.log(`%c The row is not split. (ROW.${e})`,"color:orange",this._currentTableDistributedRows[e]);const n=this._node.getTop(i,this._currentTable),o=this._currentTableSplitBottom-n;e=this._handleRowOverflow(e,i,o,this._currentTableFullPartContentHeight,t,"Split failed — move row to next page","Split failed — scaled TDs for full-page")}this.logGroupEnd(`🔳 Try to split the ROW ${e} (from ${this._currentTableDistributedRows.length}) (...if canSplitRow)`)}}return this.logGroupEnd(`Row # ${n} (from ${o}) is checked`),e}_splitTableRow(e,t,n,o){this._debug._&&console.group(`%c ➗ Split the ROW ${e}`,"color:magenta;","");const i=this._node.getTableRowShellHeightByTD(t);this._debug._&&console.log("🧿 currentRowTdHeights",i),this._node.setFlagSlice(t);const s=[...this._DOM.getChildren(t)],r=this._node.getSplitPointsPerCells(s,i,n,o,t);this._debug._&&console.log("[✖️] getSplitPointsPerCells result:",r);let l=r.splitPointsPerCell;const a=r.isFirstPartEmptyInAnyCell;let h=r.needsScalingInFullPage;const c=[];if(l.some((e=>e.length))){const n=this._sliceCellsBySplitPoints(s,l);this._debug._&&console.log("🟣 slicedTDsPerOrigTD",n);const o=Math.max(...n.map((e=>e.length)));for(let i=0;i<o;i++){const o=this._DOM.cloneNodeWrapper(t);this._DOM.setAttribute(o,`.splitted_row_${e}_part_${i}`),[...s].forEach(((e,t)=>{const s=n[t][i]||this._DOM.cloneNodeWrapper(e);this._DOM.insertAtEnd(o,s)})),c.push(o)}}else this._debug._&&console.log("🔴 There is no Split");return this.logGroupEnd(`%c ➗ Split the ROW ${e}`),{newRows:c,isFirstPartEmptyInAnyTD:a,needsScalingInFullPage:h}}_sliceCellsBySplitPoints(e,t){return t.map(((t,n)=>{const o=e[n];return this._node.sliceNodeBySplitPoints({index:n,rootNode:o,splitPoints:t})}))}_collectCurrentTableEntries(){this._currentTableEntries=this._node.getTableEntries(this._currentTable)}_rowHasSpan(e){const t=[...this._DOM.getChildren(e)];for(const e of t){const t=this._DOM.getElementTagName(e);if("TD"!==t&&"TH"!==t)continue;const n=parseInt(e.getAttribute("rowspan"));if(Number.isFinite(n)&&n>1)return!0}return!1}_collectCurrentTableMetrics(){const e=this._node.getEmptyNodeHeight(this._currentTable,'<tr style="padding:0;border:0;"><td style="padding:0;border:0;"></td></tr>'),t=this._node.getTopWithMargin(this._currentTable,this._currentRoot),n=this._DOM.getElementOffsetHeight(this._currentTableEntries.caption)||0,o=this._DOM.getElementOffsetTop(this._currentTableDistributedRows[0],this._currentTable)-n||0;this._currentTableTfootHeight=this._DOM.getElementOffsetHeight(this._currentTableEntries.tfoot)||0,this._currentTableFirstPartContentBottom=this._currentFirstPageBottom-t-e-this._signpostHeight,this._currentTableFullPartContentHeight=this._currentFullPageHeight-n-o-this._currentTableTfootHeight-e-2*this._signpostHeight}_getDistributedRows(e){return[...e.rows,...e.tfoot?[e.tfoot]:[]]}_updateCurrentTableDistributedRows(){this._currentTableDistributedRows=this._getDistributedRows(this._currentTableEntries)}_analyzeCurrentTableStructure(){const e=this._currentTableEntries,t=this._currentTableDistributedRows||[];let n=!1,o=!1,i=!1,s=!1,r=null;try{Array.isArray(e.unexpected)&&e.unexpected.length>0&&(s=!0)}catch(e){}for(const e of t){if("TFOOT"===this._DOM.getElementTagName(e))continue;const t=[...this._DOM.getChildren(e)].filter((e=>{const t=this._DOM.getElementTagName(e);return"TD"===t||"TH"===t}));null==r&&(r=t.length),t.length!==r&&(i=!0);for(const e of t){const t=parseInt(e.getAttribute("colspan")),i=parseInt(e.getAttribute("rowspan"));if(Number.isFinite(t)&&t>1&&(o=!0),Number.isFinite(i)&&i>1){n=!0;break}}if(n)break}this._currentTableHasRowspan=n,this._currentTableHasColspan=o,this._currentTableInconsistentCells=i,this._currentTableHasUnexpectedChildren=s,this._debug._&&(n&&console.warn("[table.guard] ROWSPAN detected — slicing not implemented; applying conservative fallback.",{table:this._currentTable}),o&&console.warn("[table.guard] COLSPAN present — handled within-row slicing; monitor results.",{table:this._currentTable}),i&&console.warn("[table.guard] Inconsistent cell counts across rows — results may vary.",{table:this._currentTable}),s&&console.warn("[table.guard] Unexpected children found in table; verify structure.",{table:this._currentTable}))}_updateCurrentTableEntriesAfterSplit(e,t){this._currentTableEntries.rows.splice(e,1,...t)}_getFinalPartReclaimedHeight(){return(this._signpostHeight||0)+(this._currentTableTfootHeight||0)}_setCurrentTableFirstSplitBottom(){this._node.getTop(this._currentTableDistributedRows[0],this._currentTable)>this._currentTableSplitBottom?(this._updateCurrentTableSplitBottom(this._currentTableFullPartContentHeight,"SPECIAL CASE: start immediately from the full height of the page"),this._debug._&&console.log("The Row 0 goes to the 2nd page")):this._updateCurrentTableSplitBottom(this._currentTableFirstPartContentBottom,"start with a short first part")}_getPaginatorAdapter(){return{label:"table",getSplitBottom:()=>this._currentTableSplitBottom,setSplitBottom:e=>{this._currentTableSplitBottom=e},computeSplitBottomForElement:e=>this._node.getTop(e,this._currentTable)+this._currentTableFullPartContentHeight,getRows:()=>this._currentTableDistributedRows,shouldAssert:()=>this._assert,getDebug:()=>this._debug,getSplitBottomLog:()=>this._logSplitBottom_}}_updateCurrentTableSplitBottom(e,t="unknown case"){Ht(this._getPaginatorAdapter(),e,t)}_registerPageStartAt(e,t,n="register page start"){At(this._getPaginatorAdapter(),e,t,n)}_scaleProblematicTDs(e,t,n){const o=[...this._DOM.getChildren(e)],i=Array.isArray(n)?n:this._getRowShellHeights(e);return this._node.scaleCellsToHeight(o,t,i)}_handleRowOverflow(e,t,n,o,i,s,r){return n<o?(this._registerPageStartAt(e,i,s),e-1):(this._scaleProblematicTDs(t,o,this._getRowShellHeights(t)),this._registerPageStartAt(e,i,r),e-1)}_getRowShellHeights(e){if(!this._currentRowShellCache)return this._node.getTableRowShellHeightByTD(e);if(this._currentRowShellCache.has(e))return this._currentRowShellCache.get(e);const t=this._node.getTableRowShellHeightByTD(e);return this._currentRowShellCache.set(e,t),t}_getRowFitDelta(e){const t=this._currentTableDistributedRows[e],n=this._node.getBottom(t,this._currentTable),o=this._currentTableDistributedRows[e+1],i=o?this._node.getTop(o,this._currentTable):n,s=i-this._currentTableSplitBottom,r=s<=0;return r?this._debug._&&console.log(`%c📐 isCurrentRowFits? %c ${r} %c ( ${i} <= ${this._currentTableSplitBottom} ) delta=${s}`,"","font-weight:bold;color:green;",""):this._debug._&&console.log(`%c📐 isCurrentRowFits? %c ${r} %c ( ${i} > ${this._currentTableSplitBottom} ) delta=${s}`,"","font-weight:bold;color:red;",""),s}_lockCurrentTableWidths(){this._node.lockTableWidths(this._currentTable)}_createTopSignpost(){return this._node.createSignpost("(table continued)",this._signpostHeight)}_createBottomSignpost(){return this._node.createSignpost("(table continues on the next page)",this._signpostHeight)}_replaceRowInDOM(e,t){this._debug._&&this._DOM.setAttribute(e,".🚫_must_be_removed"),this._DOM.insertInsteadOf(e,...t)}_createAndInsertTableSlice({startId:e,endId:t,table:n,tableEntries:o}){return function(e,{startId:t,endId:n,table:o,tableEntries:i}){if(e._assert){const e=i&&i.rows?i.rows.length:0;console.assert(Number.isInteger(t)&&Number.isInteger(n),`createAndInsertTableSlice: non-integer bounds: startId=${t}, endId=${n}`),console.assert(e>=0,`createAndInsertTableSlice: invalid rows length: ${e}`),console.assert(t>=0&&n>=0&&t<n&&n<=e,`createAndInsertTableSlice: out-of-range slice [${t}, ${n}) for rowsLen=${e}`)}const s=e._node.createWithFlagNoBreak();e._DOM.insertBefore(o,s);const r=i.rows.slice(t,n);t&&e._DOM.insertAtEnd(s,$t(e));const l=e._node.createTable({wrapper:e._DOM.cloneNodeWrapper(o),colgroup:e._DOM.cloneNode(i.colgroup),caption:e._DOM.cloneNode(i.caption),thead:e._DOM.cloneNode(i.thead),tbody:r});return e._DOM.insertAtEnd(s,l,function(e){return e._node.createSignpost("(table continues on the next page)",e._signpostHeight)}(e)),s}(this,{startId:e,endId:t,table:n,tableEntries:o})}_createAndInsertTableFinalSlice({table:e}){return function(e,{table:t}){const n=e._node.createWithFlagNoBreak();return e._DOM.insertBefore(t,n),e._DOM.insertAtEnd(n,$t(e),t),n}(this,{table:e})}}class It{constructor({config:e,DOM:t,node:n,selector:o}){this._debug=e.debugMode?{...e.debugConfig.tableLike}:{},this._DOM=t,this._selector=o,this._node=n,this._minLeftLines=2,this._minDanglingLines=2,this._minBreakableLines=this._minLeftLines+this._minDanglingLines,this._minLeftRows=1,this._minDanglingRows=1,this._minBreakableRows=1,this._minPreFirstBlockLines=3,this._minPreLastBlockLines=3,this._minPreBreakableLines=this._minPreFirstBlockLines+this._minPreLastBlockLines,this._minBreakableGridRows=4,this._imageReductionRatio=.8,this._signpostHeight=parseFloat(e.splitLabelHeight)||0}split(e,t,n,o,i){const s=i||this._DOM.getComputedStyle(e);this._debug._&&console.log("root",o);const r=this._node.getPreparedChildren(e),l=this._node.getTop(e,o),a=this._node.getEmptyNodeHeight(e),h=n-a;let c=r,g=0,d=[],p=t-l-a;const u=s.position;"relative"!=u&&this._DOM.setStyles(e,{position:"relative"});for(let t=0;t<c.length;t++){const n=c[t];this._node.getBottom(n,e)>p&&(t&&d.push(t),t&&(g+=1),p=t?this._node.getTop(n,e)+h:h)}if(this._DOM.setStyles(e,{position:u}),!d.length)return this._debug._&&console.log("splitters.length",d.length),[];d.push(null);const _=d.map(((t,n,o)=>{const i=this._DOM.cloneNodeWrapper(e);this._node.setFlagNoBreak(i),this._node.unmarkPageStartElement(i);const s=o[n-1]||0,r=t||o[o.length];return this._DOM.insertAtEnd(i,...c.slice(s,r)),i}));return this._node.markPartNodesWithClass(_),this._DOM.replaceNodeContentsWith(e,..._),this._DOM.removeAllClasses(e),this._DOM.removeAllStyles(e),this._DOM.setStyles(e,{display:"contents"}),this._DOM.setAttribute(e,"[slough-node]",""),_}}const Wt="background:#999;color:#FFF;padding: 0 4px;";class Gt{constructor({config:e,DOM:t,node:n,selector:o}){this._debug=e.debugMode?{...e.debugConfig.grid}:{},this._DOM=t,this._selector=o,this._node=n,this._minBreakableGridRows=4,this._signpostHeight=parseFloat(e.splitLabelHeight)||0}split(e,t,n,o){this._debug._&&console.group("%c_splitGridNode","background:#00FFFF");const i=this._node.getPreparedChildren(e),s=this._DOM.getComputedStyle(e),r=e.style.position,l="static"===s.position,a=()=>{l&&(r?this._DOM.setStyles(e,{position:r}):e.style.removeProperty("position"))};if(!i.length)return a(),this._debug._&&console.groupEnd(),[];l&&this._DOM.setStyles(e,{position:"relative"});const h=this._scanGridLayout(e,s);if(!h.safe)return this._debug._&&console.warn("[grid.split] skip:",h.reason),a(),this._debug._&&console.groupEnd(),[];const c=[],g=[];let d=!1,p=!1;const u=new Set;i.forEach((t=>{const n=this._node.getTop(t,e),o=g.length?g[g.length-1]:null;if(!c.length||Math.abs(n-o)>.5)return c.push([t]),void g.push(n);c[c.length-1].push(t);const i=this._DOM.getComputedStyle(t),s=i.gridRowEnd||"",r=i.gridColumnEnd||"";d=d||s.includes("span"),p=p||r.includes("span");const l=parseInt(i.gridRowStart,10);Number.isFinite(l)&&u.add(l)}));const _=c.length,f=this._DOM.getElementOffsetHeight(e);if(u.size>0&&Math.max(...u)>_)return this._debug._&&console.warn("[grid.split] skip: implicit row gaps detected"),a(),this._debug._&&console.groupEnd(),[];if(d||p)return this._debug._&&console.warn("[grid.split] skip: span detected (row or column)"),a(),this._debug._&&console.groupEnd(),[];if(_<this._minBreakableGridRows&&f<n)return this._debug._&&console.log("%c END DONT _splitGridNode",Wt),a(),this._debug._&&console.groupEnd(),[];const m=[...g,f];this._debug._&&console.log("gridPseudoRowsTopPoints",m);const b=this._node.getTop(e,o),M=this._node.getEmptyNodeHeight(e),O=t-b-M,D=n-M;this._debug._&&console.log("\n • firstPartHeight",O,"\n • fullPagePartHeight",D);const P=m;let w=[],S=O;for(let e=0;e<P.length;e++)P[e]>S&&(e>0?w.push(e-1):this._debug._&&console.warn("[grid.split] row0 overflow tail window → use full-page window"),S=P[Math.max(e-1,0)]+D);this._debug._&&console.log("splitsIds",w);const E=(t,n)=>{if(t===n)return this._debug._&&console.warn("[grid.split] skip empty slice request",t,n),null;this._debug._&&console.log(`=> insertGridSplit(${t}, ${n})`);const o=c.slice(t,n).flat();this._debug._&&console.log("partEntries",o);const i=this._DOM.cloneNodeWrapper(e);return this._node.copyNodeWidth(i,e),this._node.setFlagNoBreak(i),e.before(i),this._DOM.insertAtEnd(i,...o),i},T=[...w.map(((e,t,n)=>E(n[t-1]||0,e))).filter(Boolean),e];return this._debug._&&console.log("splits",T),T.forEach(((e,t)=>this._DOM.setAttribute(e,"[part]",`${t}`))),this._node.setFlagNoBreak(e),a(),this._debug._&&console.log("%c END _splitGridNode",Wt),this._debug._&&console.groupEnd(),T}_scanGridLayout(e,t){const n=t.gridAutoFlow||"";if(!n.startsWith("row"))return{safe:!1,reason:`grid-auto-flow=${n}`};if(n.includes("dense"))return{safe:!1,reason:"grid-auto-flow dense not supported yet"};if("none"!==(t.gridTemplateAreas||"none"))return{safe:!1,reason:"grid-template-areas present"};const o=t.gridTemplateColumns||"",i=t.gridTemplateRows||"",s=e=>e.includes("subgrid")||e.includes("auto-fit")||e.includes("auto-fill")||e.includes("fit-content");if(s(o)||s(i))return{safe:!1,reason:"complex track sizing (subgrid/auto-fit/fit-content)"};return/\[.*?\]/.test(o)||/\[.*?\]/.test(i)?{safe:!1,reason:"named grid lines detected"}:{safe:!0}}}const zt="background:#999;color:#FFF;padding: 0 4px;";class Vt{constructor({config:e,DOM:t,node:n,selector:o}){this._debug=e.debugMode?{...e.debugConfig.pre}:{},this._DOM=t,this._selector=o,this._node=n,this._minLeftLines=2,this._minDanglingLines=2,this._minBreakableLines=this._minLeftLines+this._minDanglingLines,this._minLeftRows=1,this._minDanglingRows=1,this._minBreakableRows=1,this._minPreFirstBlockLines=3,this._minPreLastBlockLines=3,this._minPreBreakableLines=this._minPreFirstBlockLines+this._minPreLastBlockLines,this._minBreakableGridRows=4,this._imageReductionRatio=.8,this._signpostHeight=parseFloat(e.splitLabelHeight)||0}split(e,t,n,o,i){const s=o||this._DOM.getComputedStyle(e),r=["%c_splitPreNode\n","color:white"];this._debug._&&console.group("%c_splitPreNode","background:cyan"),this._debug._&&console.log(...r,"node",e);const l=this._node.getTop(e,i),a=this._DOM.getElementOffsetHeight(e),h=this._node.getLineHeight(e),c=this._node.getEmptyNodeHeight(e,!1);if(a<c+h*this._minPreBreakableLines)return this._debug._&&console.log("%c END _splitPreNode (small node)",zt),[];const g=this._DOM.getChildNodes(e);if(this._debug._&&console.log("_children:",g.length),0==g.length)return this._debug._&&console.log("%c END _splitPreNode (not breakable)",zt),[];if(g.length>1)return this._debug._&&console.log("%c END _splitPreNode TODO!",zt),[];{if(this._DOM.isElementNode(g[0])){const e=g[0];return this._debug._&&console.warn("is Element Node",e),this._debug._&&console.log("%c END _splitPreNode ???????",zt),[]}this._node.isWrappedTextNode(g[0])&&this._debug._&&console.warn(`is TEXT Node: ${g[0]}`);const o=g[0].wholeText,i=this._node.splitTextByLinesGreedy(o);if(i.length<this._minPreBreakableLines)return this._debug._&&console.log("%c END _splitPreNode few lines",zt),[];const a=i.splice(0,this._minPreFirstBlockLines).join(""),h=i.splice(-this._minPreLastBlockLines).join("");i.unshift(a),i.push(h);const d=i.map((e=>{const t=this._node.createWithFlagNoBreak();return this._DOM.setInnerHTML(t,e),t}));this._debug._&&console.log("linesFromNode",d),this._DOM.replaceNodeContentsWith(e,...d);const p=n-c;let u=0,_=[],f=t-l-c;const m=s.position;"relative"!=m&&this._DOM.setStyles(e,{position:"relative"});for(let t=0;t<d.length;t++){const n=d[t];this._node.getBottom(n,e)>f&&(t&&_.push(t),t&&(u+=1),f=t?this._node.getTop(n,e)+p:p)}if(this._DOM.setStyles(e,{position:m}),!_.length)return this._debug._&&console.log("%c END _splitPreNode NO SPLIITERS",zt),[];_.push(null),this._debug._&&console.log(...r,"splitters",_);const b=_.map(((t,n,o)=>{const i=this._DOM.cloneNodeWrapper(e);this._node.setFlagNoBreak(i);const s=o[n-1]||0,r=t||o[o.length];return this._DOM.insertAtEnd(i,...d.slice(s,r)),i}));return this._node.markPartNodesWithClass(b),this._debug._&&console.log(...r,"newPreElementsArray",b),this._DOM.replaceNodeContentsWith(e,...b),this._DOM.setStyles(e,{display:"contents"}),this._DOM.setAttribute(e,"[slough-node]",""),this._DOM.removeAllClasses(e),this._debug._&&console.log("%c END _splitPreNode",zt),this._debug._&&console.groupEnd(),b}}}class jt{constructor({config:e,DOM:t,selector:f}){this._config=e,this._DOM=t,this._selector=f,this._debug=e.debugMode?{...e.debugConfig.node}:{},this._assert=!!e.consoleAssert,this._markupDebugMode=this._config.markupDebugMode,Object.assign(this,n),Object.assign(this,o),Object.assign(this,i),Object.assign(this,s),Object.assign(this,r),Object.assign(this,l),Object.assign(this,a),Object.assign(this,h),Object.assign(this,c),Object.assign(this,g),Object.assign(this,d),Object.assign(this,p),Object.assign(this,u),Object.assign(this,_),this._paragraph=new xt({config:this._config,DOM:this._DOM,selector:this._selector,node:this}),this._pre=new Vt({config:this._config,DOM:this._DOM,selector:this._selector,node:this}),this._table=new Rt({config:this._config,DOM:this._DOM,selector:this._selector,node:this}),this._grid=new Gt({config:this._config,DOM:this._DOM,selector:this._selector,node:this}),this._tableLike=new It({config:this._config,DOM:this._DOM,selector:this._selector,node:this})}clearTemplates(e){this._DOM.getAll("template",e).forEach((e=>this._DOM.removeNode(e)))}notSolved(e){this._DOM.getElementTagName(e);return!1}}function Ut(e){return e?.length?e?.split(/\s+/).filter(Boolean):[]}const qt="#66CC00",Yt=`color: ${qt};font-weight:bold`,Kt=`border:1px solid ${qt};background:#EEEEEE;color:${qt};`,Zt="background:#999;color:#FFF;padding: 0 4px;";class Jt{constructor({config:e,DOM:t,node:n,selector:o,layout:i,referenceWidth:s,referenceHeight:r}){this._debug=e.debugMode?{...e.debugConfig.pages}:{},this._assert=!!e.consoleAssert,this._selector=o,this._node=n,this._noHangingSelectors=Ut(e.noHangingSelectors),this._pageBreakBeforeSelectors=Ut(e.pageBreakBeforeSelectors),this._pageBreakAfterSelectors=Ut(e.pageBreakAfterSelectors),this._forcedPageBreakSelectors=Ut(e.forcedPageBreakSelectors),this._noBreakSelectors=Ut(e.noBreakSelectors),this._garbageSelectors=Ut(e.garbageSelectors),this._DOM=t,this._root=i.root,this._contentFlow=i.contentFlow,this._referenceWidth=s,this._referenceHeight=r,this._minLeftLines=2,this._minDanglingLines=2,this._minBreakableLines=this._minLeftLines+this._minDanglingLines,this._minLeftRows=1,this._minDanglingRows=1,this._minBreakableRows=1,this._minPreFirstBlockLines=3,this._minPreLastBlockLines=3,this._minPreBreakableLines=this._minPreFirstBlockLines+this._minPreLastBlockLines,this._minBreakableGridRows=4,this._imageReductionRatio=.8,this._signpostHeight=parseFloat(e.splitLabelHeight)||0,this._commonLineHeight=this._node.getLineHeight(this._root),this._minimumBreakableHeight=this._commonLineHeight*this._minBreakableLines,this.pages=[]}calculate(){return this._removeGarbageElements(),this._prepareNoHangingElements(),this._prepareForcedPageBreakElements(),this._prepareNoBreakElements(),this._calculate(),this._debug._&&console.log("%c ✔ Pages.calculate()",Kt,this.pages),this.pages}_removeGarbageElements(){if(this._garbageSelectors.length){this._DOM.getAll(this._garbageSelectors,this._contentFlow).forEach((e=>{this._DOM.removeNode(e)}))}}_prepareNoHangingElements(){if(this._noHangingSelectors.length){this._DOM.getAll(this._noHangingSelectors,this._contentFlow).forEach((e=>{this._node.setFlagNoHanging(e);const t=this._node.findLastChildParent(e,this._contentFlow);t&&this._node.setFlagNoHanging(t,"parent")}))}}_prepareNoBreakElements(){if(this._noBreakSelectors.length){this._DOM.getAll(this._noBreakSelectors,this._contentFlow).forEach((e=>this._node.setFlagNoBreak(e)))}}_prepareForcedPageBreakElements(){const e=this._pageBreakBeforeSelectors.length?this._DOM.getAll(this._pageBreakBeforeSelectors,this._contentFlow):[],t=this._pageBreakAfterSelectors.length?this._DOM.getAll(this._pageBreakAfterSelectors,this._contentFlow):[],n=this._DOM.getAll(this._forcedPageBreakSelectors,this._contentFlow);if(e.length){const t=e[0],n=this._node.findFirstChildParent(t,this._contentFlow)||t;this._node.isAfterContentFlowStart(n)&&e.shift()}if(t.length){const e=t.at(-1),n=this._node.findLastChildParent(e,this._contentFlow)||e,o=this._DOM.getRightNeighbor(n);this._node.isContentFlowEnd(o)&&t.pop()}e.length&&e.forEach((e=>{const t=this._node.findBetterForcedPageStarter(e,this._contentFlow);t&&this._DOM.insertBefore(t,this._node.createForcedPageBreak())})),n&&n.forEach((e=>{if(!this._node.isForcedPageBreak(e)){const t=this._node.findBetterForcedPageStarter(e,this._contentFlow);t&&this._DOM.insertBefore(t,this._node.createForcedPageBreak())}})),t.length&&t.forEach((e=>{const t=this._node.findLastChildParent(e,this._contentFlow);t&&(e=t),this._node.isForcedPageBreak(e.nextElementSibling)||this._DOM.insertAfter(e,this._node.createForcedPageBreak())}))}_calculate(){this._debug._&&console.groupCollapsed("•• init data ••"),this._debug._&&console.log("this._referenceHeight",this._referenceHeight,"\n","this._noHangingSelectors",this._noHangingSelectors,"\n","this._pageBreakBeforeSelectors",this._pageBreakBeforeSelectors,"\n","this._pageBreakAfterSelectors",this._pageBreakAfterSelectors,"\n","this._forcedPageBreakSelectors",this._forcedPageBreakSelectors,"\n","this._noBreakSelectors",this._noBreakSelectors),this._debug._&&console.groupEnd("•• init data ••"),this._registerPageStart(this._DOM.getElement(this._selector.contentFlowStart,this._contentFlow));const e=this._node.getBottomWithMargin(this._contentFlow,this._root);if(e<this._referenceHeight)return this._debug._&&console.log(`contentFlow (${e}) fits on the page (${this._referenceHeight})`),void this._node.findAllForcedPageBreakInside(this._contentFlow).forEach((e=>this._registerPageStart(e)));const t=this._node.getPreparedChildren(this._contentFlow);this._debug._&&console.groupCollapsed("%c🚸 children(contentFlow)",Kt),this._debug._&&console.log(t),this._debug._&&console.groupEnd("%c🚸 children(contentFlow)",Kt),this._parseNodes({array:t})}_registerPageStart(e,t=!1){if(this._debug._registerPageStart&&console.log("%c📍","background:yellow;font-weight:bold","\n  improveResult:",t,"\n  passed pageStart:",e),this._node.isPageStartElement(e))return;t&&(e=this._node.findBetterPageStart(e,this.pages.at(-1)?.pageStart,this._root)),this._DOM.getElementOffsetParent(e)||this._debug._registerPageStart&&console.warn("🚨 pageStart has no offsetParent. Check the caller.",e);const n=this._node.getTopWithMargin(e,this._root),o=n+this._referenceHeight;this.pages.push({pageStart:e,pageBottom:o}),this._node.markPageStartElement(e,this.pages.length),this._debug._registerPageStart&&console.log(`%c📍register page ${this.pages.length}`,"background:yellow;font-weight:bold","\n  improved result:",t,"\n  pageTop:",n,"\n  pageBottom:",o,"\n  pageStart:",e)}_parseNodes({array:e,previous:t,next:n,parent:o,parentBottom:i}){this._debug._parseNodes&&console.log("🔵 _parseNodes","\narray:",[...e],"\ntracedParent:",o);for(let s=0;s<e.length;s++){const r=0==s&&!e[s-1],l=s===e.length-1;this._parseNode({previousElement:e[s-1]||t,currentElement:e[s],nextElement:e[s+1]||n,isCurrentFirst:r,parent:o,parentBottom:l?i:void 0})}}_parseNode({isCurrentFirst:e,previousElement:t,currentElement:n,nextElement:o,parent:i,parentBottom:s}){const r=["%c_parseNode\n","color:white"];if(this._debug._parseNode&&console.group("%c_parseNode",Yt,""+(s?"★last★":"regular"),"📄",this.pages.length),this._debug._parseNode&&console.log(...r,"3 nodes: ",{previousElement:t,currentElement:n,nextElement:o},"\n","\ncurrent: ",n,"\nparent: ",i,"\nisCurrentFirst: ",e),this._debug._parseNode&&console.log(...r,"parent:",i,"\n","parentBottom:",s,"\n","isCurrentFirst:",e,"\n","parent:",i,"\n"),!o)return this._node.markProcessed(n,"content-flow-end"),this._debug._parseNode&&console.log("%c END _parseNode (!nextElement)",Zt),void(this._debug._parseNode&&console.groupEnd());const l=this.pages.at(-1).pageBottom,a=this._node.getBottomWithMargin(n,this._root),h=s||a;let c=s;const g=this._node.getTop(n,this._root),d=s>g+this._referenceHeight;if(s&&d){if(c=void 0,this._debug._parseNode&&console.log("🪁 Tile: We got a tail from the lower shells of the last child. Giving up our “last child” rule here and will try to insert a page break at the end of some parent. ",{parentBottom:s,currentParentBottom:c,currentElementBottom:a,newPageBottom:l},{currentElement:n,parent:i}),a<=l){this._debug._parseNode&&console.log("🪁 Tile: currentElementBottom <= newPageBottom");const e=[];let t=n;for(this._debug._parseNode&&console.log("🪁 Tile: currentElement",n);t&&t!==i;)e.push({element:t,bottom:this._node.getBottomWithMargin(t,this._root)}),t=t.parentElement;if(t!==i)throw new Error("parent not found in the ancestor chain");e.push({element:i,bottom:s}),this._debug._parseNode&&console.log("🪁 Tile: _parents",e);let o=l;this._debug._parseNode&&console.log("🪁 Tile: _currentPageBottom = newPageBottom",o);for(let t=0;t<e.length;t++)if(this._debug._parseNode&&console.log("🪁 Tile: _parents[i].bottom",e[t].bottom,e[t].element),e[t].bottom>o){this._debug._parseNode&&console.log("🪁 Tile: _parents[i].bottom > _currentPageBottom",e[t].bottom,">",o,e[t].element);const n=this._node.createNeutral();n.classList.add("service"),this._DOM.insertAtEnd(e[t].element,n),this._registerPageStart(n),this._debug._parseNode&&console.log("_registerPageStart",n),this._node.markProcessed(n,"node is ForcedPageBreak");const i=this.pages.at(-1).pageBottom;if(this._debug._parseNode&&console.log(o,i,s),!(s>i))return this._debug._parseNode&&console.log("%c END _parseNode (bottom tile of parents)",Zt),void(this._debug._parseNode&&console.groupEnd());this._debug._&&console.log("🧧 • parentBottom > justUpdatedPageBottom"),o=i,this._debug._parseNode&&console.log("new _currentPageBottom",o)}return this._debug._parseNode&&console.log("%c END _parseNode (bottom tile of parents)",Zt),void(this._debug._parseNode&&console.groupEnd())}this._debug._parseNode&&console.log("🪁 Tile: currentElementBottom > newPageBottom","DOING NOTHING")}const p=c||a;if(this.pages.at(-1).pageStart===n&&(this._node.isNoBreak(n)||p<=l))return this._node.markProcessed(n,"node is already registered and fits in the page"),this._debug._parseNode&&console.log("%c END _parseNode (node is already registered and fits in the next page)",Zt),void(this._debug._parseNode&&console.groupEnd());if(g>=l&&a-g){const e=i?this._node.getTopWithMargin(i,this._root):void 0,t=i&&e&&g-e>=this._referenceHeight;if(!t){const e=this._DOM.getComputedStyle(n)?.display||"";if(e.includes("inline")||"contents"===e)return this._registerPageStart(n,!0),this._debug._parseNode&&console.log("%c END _parseNode (registered new page start)",Zt),void(this._debug._parseNode&&console.groupEnd())}this._registerPageStart(n,!t)}if(this._node.isForcedPageBreak(n))return this._registerPageStart(n),this._node.markProcessed(n,"node is ForcedPageBreak"),this._debug._parseNode&&console.log("%c END _parseNode (isForcedPageBreak)",Zt),void(this._debug._parseNode&&console.groupEnd());this._debug._&&console.assert(this._DOM.getElementOffsetParent(n),"it is expected that the element has an offset parent",n);const u=this._node.getTop(o,this._root);if(this._debug._parseNode&&console.log(...r,"• newPageBottom",l,"\n","• nextElementTop",u),u<=l)this._debug._parseNode&&console.log("nextElementTop <= newPageBottom",u,"<=",l),this._node.markProcessed(n,"node fits"),this._node.findAllForcedPageBreakInside(n).forEach((e=>{this._node.markProcessed(e,"node is ForcedPageBreak (inside a node that fits)"),this._registerPageStart(e)}));else{if(this._debug._parseNode&&console.log("nextElementTop > newPageBottom",u,">",l),p<=l)return this._debug._parseNode&&console.log("currentBlockBottom <= newPageBottom",p,"<=",l,"\n register nextElement as pageStart"),this._node.isNoHanging(n)?(this._debug._parseNode&&console.log("currentElement fits / last, and _isNoHanging => move it to the next page"),this._node.markProcessed(n,"it fits & last & _isNoHanging => move it to the next page"),this._registerPageStart(n,!0),this._debug._parseNode&&console.log("%c END _parseNode (isNoHanging)",Zt),void(this._debug._parseNode&&console.groupEnd())):(this._registerPageStart(o),this._node.markProcessed(n,"fits, its bottom falls exactly on the cut"),this._node.markProcessed(o,"starts new page, its top is exactly on the cut"),this._debug._parseNode&&console.log("%c END _parseNode (currentElement fits, register the next element)",Zt),void(this._debug._parseNode&&console.groupEnd()));const d=this._node.resolveReplacedElement(n,{prefer:"first"});if(d){const e=this._node.isSVG(d),t=e?this._node.createSignpost(d):d;let r=i?l-this._node.getTop(t,this._root):l-this._node.getTop(i,this._root);r-=s?s-this._node.getBottom(t,this._root):0;let a=this._referenceHeight-(i?this._node.getTop(t,this._root)-this._node.getTop(i,this._root):0);const h=this._DOM.getElementOffsetHeight(t),g=this._DOM.getElementOffsetWidth(t);if(this._debug._parseNode&&console.log("🖼️🖼️🖼️🖼️🖼️🖼️\n",`H-space: ${r}, image Height: ${h}, image Width: ${g}`,n,"\n parent",i,"parentBottom",s,"currentParentBottom",c),h<this._referenceWidth&&this._debug._parseNode&&console.warn("%c IMAGE is too wide","color: red"),h<r)return this._node.markProcessed(n,"IMG that fits, and next starts on next"),this._registerPageStart(o),this._debug._parseNode&&console.log("Register next elements; 🖼️🖼️🖼️ IMG fits:",n),this._debug._parseNode&&console.log("%c END _parseNode 🖼️ IMG fits",Zt),void(this._debug._parseNode&&console.groupEnd());const p=r/h;if(p>this._imageReductionRatio)return this._debug._parseNode&&console.log("Register next elements; 🖼️🖼️🖼️ IMG RESIZE to availableImageNodeSpace:",r,n),this._node.markProcessed(n,`IMG with ratio ${p}, and next starts on next`),this._node.fitElementWithinBoundaries({element:d,height:h,width:g,vspace:r,hspace:this._referenceWidth}),this._registerPageStart(o),this._debug._parseNode&&console.log("%c END _parseNode 🖼️ IMG scaled",Zt),void(this._debug._parseNode&&console.groupEnd());this._node.markProcessed(n,"IMG starts on next");const u=e?t:d;return this._registerPageStart(u,!0),this._debug._parseNode&&console.log("🖼️ register Page Start",n),h>a&&(this._node.fitElementWithinBoundaries({element:d,height:h,width:g,vspace:a,hspace:this._referenceWidth}),this._node.markProcessed(n,"IMG starts on next and resized"),this._debug._parseNode&&console.log("🖼️ ..and fit it to full page",n)),this._debug._parseNode&&console.log("%c END",Zt),void(this._debug._parseNode&&console.groupEnd())}if(n.style.height){this._debug._parseNode&&console.log("🥁 currentElement has HEIGHT",n.style.height);const e=l-g,t=u-g,i=e/t,s=this._referenceHeight/t;return this._debug._parseNode&&console.log("\n🥁 currentElementTop",g,"\n🥁 newPageBottom",l,"\n🥁 availableSpace",e,"\n🥁 currentElementContextualHeight",t,"\n🥁 availableSpaceFactor",i,"\n🥁 fullPageFactor",s),this._debug._parseNode&&console.assert(i<1),i>.8?(this._debug._parseNode&&console.log("🥁 availableSpaceFactor > 0.8: ",i),this._DOM.setStyles(n,{transform:`scale(${i})`,"transform-origin":"top center"}),this._registerPageStart(o),this._node.markProcessed(n,"processed as a image, has been scaled down within 20%, the next one starts a new page"),this._node.markProcessed(o,"the previous one was scaled down within 20%, and this one starts a new page."),this._debug._parseNode&&console.log("%c END _parseNode (has height & scale)",Zt),void(this._debug._parseNode&&console.groupEnd())):(s<1&&(this._debug._parseNode&&console.log("🥁 fullPageFactor < 1: ",s),this._node.markProcessed(n,"processed as a image, has been scaled down, and starts new page"),this._DOM.setStyles(n,{transform:`scale(${s})`,"transform-origin":"top center"})),this._debug._parseNode&&console.log("🥁 _registerPageStart",n),this._registerPageStart(n,!0),this._node.markProcessed(n,"processed as a image, starts new page"),this._debug._parseNode&&console.log("%c END _parseNode (has height & put on next page)",Zt),void(this._debug._parseNode&&console.groupEnd()))}if(this._debug._parseNode&&console.log("split or not? \n","currentBlockBottom",p),this._debug._parseNode&&console.log("currentParentBottom || currentElementBottom",{currentParentBottom:c,currentElementBottom:a},"currentBlockBottom > newPageBottom",p,">",l),this._DOM.getElementOffsetHeight(n)<this._minimumBreakableHeight)return this._registerPageStart(n,!0),this._node.markProcessed(n,"starts new page, #fewLines"),this._debug._parseNode&&console.log("%c END _parseNode #fewLines",Zt),void(this._debug._parseNode&&console.groupEnd());const _=this._node.getSplitChildren(n,l,this._referenceHeight,this._root);this._debug._parseNode&&console.log("try to break it and loop the children:",_);const f=_.length;this._debug._parseNode&&console.log(...r,"childrenNumber ",f),this._debug._parseNode&&console.log(...r,"currentElement ",n);const m=(e||s)&&i||n;if(f){const e=this._node.isFullySPlitted(n)||this._node.isSlough(n);this._debug._parseNode&&console.log({isFullySPlittedParent:e,parent:i,tracedParent:m}),this._parseNodes({array:_,previous:t,next:o,parent:e?void 0:m,parentBottom:e?void 0:h}),this._node.markProcessed(n,"getSplitChildren and _parseNodes")}else this._debug._parseNode&&console.log(...r,"_registerPageStart (from _parseNode): \n",n),this._registerPageStart(n,!0),this._node.markProcessed(n,"doesn't fit, has no children, register it or parents")}this._debug._parseNode&&console.log("%c END _parseNode",Zt),this._debug._parseNode&&console.groupEnd()}}class Xt{constructor({config:e,DOM:t,node:n,selector:o,layout:i}){this._debug=e.debugMode?{...e.debugConfig.paper}:{},this._DOM=t,this._selector=o,this._node=n,this._frontpageTemplate=i.frontpageTemplate,this._headerTemplate=i.headerTemplate,this._footerTemplate=i.footerTemplate,this._paperBodySelector=o?.paperBody||".paperBody",this._paperHeaderSelector=o?.paperHeader||".paperHeader",this._paperFooterSelector=o?.paperFooter||".paperFooter",this._headerContentSelector=o?.headerContent||".headerContent",this._footerContentSelector=o?.footerContent||".footerContent",this._frontpageContentSelector=o?.frontpageContent||".frontpageContent",this._virtualPaperSelector=o?.virtualPaper||".virtualPaper",this._virtualPaperTopMarginSelector=o?.virtualPaperTopMargin||".virtualPaperTopMargin",this._virtualPaperBottomMarginSelector=o?.virtualPaperBottomMargin||".virtualPaperBottomMargin",this._pageNumberRootSelector=o?.pageNumberRoot||void 0,this._pageNumberCurrentSelector=o?.pageNumberCurrent||void 0,this._pageNumberTotalSelector=o?.pageNumberTotal||void 0,this._paperHeight,this._frontpageFactor,this.headerHeight,this.footerHeight,this.bodyHeight,this.bodyWidth,this._calculatePaperParams()}create({currentPage:e,totalPages:t}){const n=this._createPaperBody(this.bodyHeight),o=this._createPaperHeader(this._headerTemplate),i=this._createPaperFooter(this._footerTemplate);return this._createPaper({header:o,body:n,footer:i,currentPage:e,totalPages:t})}createFrontpage({currentPage:e,totalPages:t}){const n=this._createFrontpageContent(this._frontpageTemplate,this._frontpageFactor),o=this._createPaperBody(this.bodyHeight,n),i=this._createPaperHeader(this._headerTemplate),s=this._createPaperFooter(this._footerTemplate);return this._createPaper({header:i,body:o,footer:s,currentPage:e,totalPages:t})}createVirtualTopMargin(){return this._node.create(this._virtualPaperTopMarginSelector)}createVirtualBottomMargin(){return this._node.create(this._virtualPaperBottomMarginSelector)}_createPaper({header:e,body:t,footer:n,currentPage:o,totalPages:i}){const s=this._node.create(this._virtualPaperSelector);return this._DOM.insertAtEnd(s,this.createVirtualTopMargin(),e,t,n,this.createVirtualBottomMargin()),o&&i&&(this._setPageNumber(e,o,i),this._setPageNumber(n,o,i)),s}_createFrontpageContent(e,t){const n=this._node.create(this._frontpageContentSelector);return e&&this._DOM.setInnerHTML(n,e),t&&this._DOM.setStyles(n,{transform:`scale(${t})`}),n}_createPaperBody(e,t){const n=this._node.create(this._paperBodySelector);return this._DOM.setStyles(n,{height:e+"px"}),t&&this._DOM.insertAtEnd(n,t),n}_createPaperHeader(e){const t=this._node.create(this._paperHeaderSelector);if(e){const n=this._node.create(this._headerContentSelector);this._DOM.setInnerHTML(n,e),this._DOM.insertAtEnd(t,n)}return t}_createPaperFooter(e){const t=this._node.create(this._paperFooterSelector);if(e){const n=this._node.create(this._footerContentSelector);this._DOM.setInnerHTML(n,e),this._DOM.insertAtEnd(t,n)}return t}_setPageNumber(e,t,n){const o=this._pageNumberRootSelector?this._DOM.getElement(this._pageNumberRootSelector,e):this._pageNumberRootSelector;if(o){const e=this._DOM.getElement(this._pageNumberCurrentSelector,o),i=this._DOM.getElement(this._pageNumberTotalSelector,o);this._DOM.setInnerHTML(e,t),this._DOM.setInnerHTML(i,n)}}_calculatePaperParams(){const e=this._createPaperBody(),t=this._createFrontpageContent(this._frontpageTemplate),n=this._createPaperHeader(this._headerTemplate),o=this._createPaperFooter(this._footerTemplate),i=this._createPaper({header:n,body:e,footer:o}),s=this._node.create("#workbench");this._DOM.setStyles(s,{position:"absolute",left:"-3000px"}),this._DOM.insertAtEnd(s,i),this._DOM.insertAtStart(this._DOM.body,s);const r=this._DOM.getElementBCR(i).height,l=this._DOM.getElementOffsetHeight(n)||0,a=this._DOM.getElementOffsetHeight(o)||0,h=this._DOM.getElementOffsetHeight(e),c=this._DOM.getElementOffsetWidth(e);this._DOM.insertAtStart(e,t);const g=this._DOM.getElementOffsetHeight(e),d=g>h?h/g:1;this._DOM.removeNode(s),l>.2*r&&console.warn("It seems that your custom header is too high"),a>.15*r&&console.warn("It seems that your custom footer is too high"),d<1&&console.warn("It seems that your frontpage content is too large. We made it smaller to fit on the page. Check out how it looks! It might make sense to fix this with styles or reduce the text amount."),this._paperHeight=r,this.headerHeight=l,this.footerHeight=a,this.bodyHeight=h,this.bodyWidth=c,this._frontpageFactor=d}}class Qt{constructor({config:e,DOM:t,selector:n,node:o,pages:i,layout:s,paper:r}){this._config=e,this._debug=e.debugMode?{...e.debugConfig.preview}:{},this._assert=!!e.consoleAssert,this._DOM=t,this._selector=n,this._node=o,this._virtualPaperGapSelector=n.virtualPaperGap,this._runningSafetySelector=n.runningSafety,this._printPageBreakSelector=n.printPageBreak,this._pageDivider=n.pageDivider,this._virtualPaper=n.virtualPaper,this._virtualPaperTopMargin=n.virtualPaperTopMargin,this._paperBody=n.paperBody,this._pages=i,this._root=s.root,this._contentFlow=s.contentFlow,this._paperFlow=s.paperFlow,this._paper=r,this._hasFrontPage=!!s.frontpageTemplate}create(){this._processFirstPage(),this._processOtherPages(),(!0===this._config.mask||"true"===this._config.mask)&&this._addMask()}_addMask(){const e=parseInt(this._config.virtualPagesGap),t=parseInt(this._config.printHeight),n=parseInt(this._config.printTopMargin),o=parseInt(this._config.printBottomMargin),i=parseInt(this._config.headerMargin),s=parseInt(this._config.footerMargin),r=this._paper.headerHeight,l=this._paper.footerHeight,a=this._paper.bodyHeight,h=r?Math.ceil(i/2):0,c=l?Math.ceil(s/2):0,g=r-h,d=l-c,p=a+h+c,u=n+g,_=t+e;this._assert&&console.assert(t===p+g+n+d+o,"Paper size calculation params do not match"),function({targetElement:e,maskStep:t,maskWindow:n,maskFirstShift:o}){e.style=`\n    -webkit-mask-image: linear-gradient(\n      black 0,\n      black ${n}px,\n      transparent ${n}px,\n      transparent ${t}px\n    );\n            mask-image: linear-gradient(\n              black 0,\n              black ${n}px,\n              transparent ${n}px,\n              transparent ${t}px\n            );\n    -webkit-mask-repeat: no-repeat;\n            mask-repeat: no-repeat;\n    -webkit-mask-size: 100% ${t}px;\n            mask-size: 100% ${t}px;\n    -webkit-mask-position: 100% ${o}px;\n            mask-position: 100% ${o}px;\n    -webkit-mask-repeat: repeat-y;\n            mask-repeat: repeat-y;\n    -webkit-mask-origin: border-box;\n            mask-origin: border-box;\n    `}({targetElement:this._contentFlow,maskStep:_,maskWindow:p,maskFirstShift:u})}_processFirstPage(){let e;if(this._hasFrontPage){const t=this._insertFrontpageSpacer(this._contentFlow,this._paper.bodyHeight);this._pages.unshift({pageStart:t}),e=this._paper.createFrontpage({currentPage:1,totalPages:this._pages.length})}else e=this._paper.create({currentPage:1,totalPages:this._pages.length});this._insertIntoPaperFlow(e),this._insertIntoContentFlow(0)}_processOtherPages(){for(let e=1;e<this._pages.length;e++){const t=this._paper.create({currentPage:e+1,totalPages:this._pages.length}),n=this._createVirtualPaperGap();this._insertIntoPaperFlow(t,n),this._insertIntoContentFlow(e,n)}}_insertIntoPaperFlow(e,t){this._insertPaper(this._paperFlow,e,t)}_insertIntoContentFlow(e,t){const n=this._pages[e].pageStart,o=this._createPageBreaker(e,t);this._DOM.insertBefore(n,o),t&&this._insertFooterSpacer(o,this._paper.footerHeight,t),this._insertHeaderSpacer(o,this._paper.headerHeight),this._updatePageStartElementAttrValue(n,e)}_createPageBreaker(e,t){const n=this._node.create(this._pageDivider);return this._DOM.setAttribute(n,"[page]",`${e+1}`),t&&this._paper.footerHeight&&this._DOM.setStyles(n,{marginTop:this._paper.footerHeight-1+"px"}),this._paper.headerHeight&&this._DOM.setStyles(n,{marginBottom:this._paper.headerHeight-1+"px"}),n}_updatePageStartElementAttrValue(e,t){this._hasFrontPage&&this._node.markPageStartElement(e,`${t+1}`)}_insertPaper(e,t,n){n?this._DOM.insertAtEnd(e,n,t):this._DOM.insertAtEnd(e,t)}_createVirtualPaperGap(){return this._node.create(this._virtualPaperGapSelector)}_createVirtualPaperTopMargin(){return this._paper.createVirtualTopMargin()}_createVirtualPaperBottomMargin(){return this._paper.createVirtualBottomMargin()}_insertFrontpageSpacer(e,t){const n=this._node.create();return this._DOM.setStyles(n,{paddingBottom:t+"px"}),this._DOM.setAttribute(n,".printFrontpageSpacer"),this._DOM.insertAtStart(e,n),n}_insertHeaderSpacer(e,t){const n=this._DOM.createDocumentFragment(),o=this._node.create(this._runningSafetySelector);this._DOM.insertAtEnd(n,this._createVirtualPaperTopMargin(),o),this._DOM.insertAtEnd(e,n)}_insertFooterSpacer(e,t,n){const o=this._DOM.createDocumentFragment(),i=this._createVirtualPaperGap(),s=this._node.create(this._runningSafetySelector);this._DOM.insertAtEnd(o,s,this._createVirtualPaperBottomMargin(),this._node.create(this._printPageBreakSelector),i),this._DOM.insertAtStart(e,o),this._balanceFooter(s,i,n)}_balanceFooter(e,t,n){const o=this._node.getTop(n,this._root)-this._node.getTop(t,this._root);this._DOM.setStyles(e,{marginBottom:o+"px"}),this._assert&&console.assert(o>=0,`balancer is negative: ${o} < 0`,t)}}class en{constructor({config:e,DOM:t,selector:n,node:o,layout:i}){this._globalDebugMode=e.debugMode,this._debug=this._globalDebugMode?{...e.debugConfig.toc}:{},this._DOM=t,this._node=o,this._tocPageNumberSelector=e.tocPageNumberSelector,this._root=i.root,this._contentFlow=i.contentFlow,this._pageDividerSelector=n.pageDivider}render(){this._globalDebugMode&&console.time("Processing TOC"),this._debug._&&console.log(`\n📑 TOC: I am here!\n\ntocPageNumberSelector:\n • ${this._tocPageNumberSelector}\n pageDividerSelector:\n • ${this._pageDividerSelector}\n      `);const e=this._DOM.getAll(this._tocPageNumberSelector,this._contentFlow);if(this._debug._&&console.log("📑 tocPageNumberBoxes",e.length),!e.length)return void(this._debug._&&console.log("📑 no valid toc"));const t=this._DOM.getAll(this._pageDividerSelector,this._contentFlow).reduce(((e,t,n)=>{const o=this._node.getTop(t,this._root)-1,i=this._DOM.getAttribute(t,"[page]");return e[o]=i,e}),{});this._debug._&&console.log("📑 dataFromPagesMarkers",t);const n=e.reduce(((e,t)=>{const n=this._DOM.getDataId(t),o=this._DOM.getElementById(n),i=this._node.getTop(o,this._root);return e[i]={box:t,id:n,targetTop:i},e}),{});this._debug._&&console.log("📑 dataFromTOC",n);const o={...t,...n};let i=0;this._debug._&&console.groupCollapsed("Processing obj");for(const e in o){const t=o[e];this._debug._&&console.log(`Processing ${e}: ${t}`),"string"==typeof t?i=t:(t.page=i,this._DOM.setInnerHTML(t.box,i))}this._debug._&&console.groupEnd("Processing obj"),this._debug._&&console.log("📑 tocObject",o),this._globalDebugMode&&console.timeEnd("Processing TOC")}}class tn{constructor({config:e,DOM:t,selector:n,node:o,layout:i}){this._config=e,this._selector=n,this._DOM=t,this._node=o,this._layout=i,this._root=i.root,this._assert=!!e.consoleAssert}init(){this._config.debugMode&&console.log("🐙 i am Validator!");const e=`${this._selector.paperFlow} ${this._selector.virtualPaperGap}`,t=`${this._selector.contentFlow} ${this._selector.virtualPaperGap}`,n=[...this._DOM.getAllElements(e)],o=[...this._DOM.getAllElements(t)],i=n.map((e=>this._node.getTop(e))),s=o.map((e=>this._node.getTop(e,this._root))),r=i.reduce(((e,t,n)=>(t!==s[n]&&e.push(n+1),e)),[]);this._assert&&console.assert(!r.length,"Problems with preview generation on the following pages: ",r)}}const nn="border:1px dashed #cccccc;background:#ffffff;color:#cccccc;";class on{constructor(e){this._debugMode=e.debugMode,this._preloader,this._preloaderTarget=document.querySelector(e.preloaderTarget)||document.body,this._preloaderBackground=e.preloaderBackground||"white"}create(){this._debugMode&&console.groupCollapsed("%c Preloader ",nn),this._insertStyle(),this._preloader=document.createElement("div"),this._preloader.classList.add("lds-dual-ring"),this._preloaderTarget.append(this._preloader),this._debugMode&&console.groupEnd("%c Preloader ",nn)}remove(){if(!this._preloader)return;let e=1;const t=setInterval((()=>{e<=.1&&(clearInterval(t),this._preloader.remove()),this._preloader.style.opacity=e,e-=.1*e}),50);this._debugMode&&console.log("%c Preloader removed ",nn)}_insertStyle(){const e=document.querySelector("head"),t=document.createElement("style");t.append(document.createTextNode(this._css())),t.setAttribute("data-preloader-style",""),e.append(t)}_css(){return`\n    /* PRELOADER */\n    .lds-dual-ring {\n      position: absolute;\n      z-index: 99999;\n      top: 0; left: 0; bottom: 0; right: 0;\n      background: ${this._preloaderBackground};\n      display: flex;\n      justify-content: center;\n      align-items: center;\n    }\n    /*\n    .lds-dual-ring:after {\n      content: " ";\n      display: block;\n      width: 64px;\n      height: 64px;\n      margin: 8px;\n      border-radius: 50%;\n      border: 6px solid #eee;\n      border-color: #eee transparent #eee transparent;\n      animation: lds-dual-ring 1.2s linear infinite;\n    }\n    @keyframes lds-dual-ring {\n      0% {\n        transform: rotate(0deg);\n      }\n      100% {\n        transform: rotate(360deg);\n      }\n    }\n    */\n  `}}class sn{constructor(e){this._debugMode=e.debugMode}run(){let e=[...document.querySelectorAll("object")];this._debugMode&&console.log(e);let t=[];return e.forEach((e=>{const n=new Promise((t=>{e.addEventListener("load",(n=>{this._debugMode&&console.log("⏰ EVENT: object load",e.clientHeight,e.clientWidth,e),t()}))}));t.push(n)})),Promise.all(t)}}const rn="color:Gray;border:1px solid;";console.info("[HTML2PDF4DOC] Version:","0.2.3");const ln=document.currentScript.dataset,an=new class{constructor(e){this.params=e,this.debugMode=e.debugMode,this.preloader=e.preloader,this.selector=f,this.config}async render(){console.time("[HTML2PDF4DOC] Total time"),this.debugMode&&console.log("🏁 document.readyState",document.readyState),document.addEventListener("readystatechange",(e=>{this.debugMode&&console.log("🏁 readystatechange",document.readyState)})),this.debugMode&&console.time("⏱️ await DOMContentLoaded time"),await new Promise((e=>{window.addEventListener("DOMContentLoaded",(t=>{this.debugMode&&console.log("⏰ EVENT: DOMContentLoaded"),e()}))})),this.debugMode&&console.timeEnd("⏱️ await DOMContentLoaded time"),this.debugMode&&console.time("⏱️ create Preloader time");const e=new on(this.params);"true"===this.preloader&&e.create(),this.debugMode&&console.timeEnd("⏱️ create Preloader time"),this.debugMode&&console.time("⏱️ Config time"),this.debugMode&&console.groupCollapsed("%c config ",rn+"color:LightGray"),this.config={...m(this.params),debugConfig:b},this.debugMode&&console.groupEnd(),this.debugMode&&console.info("⚙️ Current config with debugConfig:",this.config),this.debugMode&&console.timeEnd("⏱️ Config time"),this.config.consoleAssert&&console.info("🧧 Assertions enabled."),this.debugMode&&console.time("⏱️ DOM helpers init time");const t=new M({DOM:window.document,config:this.config});this.debugMode&&console.timeEnd("⏱️ DOM helpers init time"),this.debugMode&&console.time("⏱️ node helpers init time");const n=new jt({config:this.config,DOM:t,selector:this.selector});this.debugMode&&console.timeEnd("⏱️ node helpers init time"),this.debugMode&&console.time("⏱️ await window load time"),await new Promise((e=>{window.addEventListener("load",(t=>{this.debugMode&&console.log("⏰ EVENT: window load"),e()}))})),this.debugMode&&console.timeEnd("⏱️ await window load time"),this.debugMode&&console.time("⏱️ Layout time"),this.debugMode&&console.groupCollapsed("%c Layout ",rn);const o=new D({config:this.config,DOM:t,selector:this.selector,node:n});if(o.create(),this.debugMode&&console.groupEnd(),this.debugMode&&console.timeEnd("⏱️ Layout time"),!o.success)return void(this.debugMode&&console.error("Failed to create layout.\n\nWe have to interrupt the process of creating PDF preview."));this.debugMode&&console.info("%c calculate Paper params ",rn),this.debugMode&&console.time("⏱️ Paper time");const i=new Xt({config:this.config,DOM:t,selector:this.selector,node:n,layout:o});if(this.debugMode&&console.timeEnd("⏱️ Paper time"),!i||!i.bodyHeight||!i.bodyWidth)return void(this.debugMode&&console.error("Failed to create paper calculations.\n\nWe have to interrupt the process of creating PDF preview."));this.debugMode&&console.time("⏱️ Preprocess time"),this.debugMode&&console.groupCollapsed("%c Preprocess ",rn),await new sn(this.config).run(),this.debugMode&&console.groupEnd(),this.debugMode&&console.timeEnd("⏱️ Preprocess time"),this.debugMode&&console.time("⏱️ Pages time"),this.debugMode&&console.group("%c Pages ",rn);const s=new Jt({config:this.config,DOM:t,selector:this.selector,node:n,layout:o,referenceHeight:i.bodyHeight,referenceWidth:i.bodyWidth}).calculate();this.debugMode&&console.groupEnd(),this.debugMode&&console.timeEnd("⏱️ Pages time"),this.debugMode&&console.time("⏱️ Preview time"),this.debugMode&&console.groupCollapsed("%c Preview ",rn),new Qt({config:this.config,DOM:t,selector:this.selector,node:n,layout:o,paper:i,pages:s}).create(),this.debugMode&&console.groupEnd(),this.debugMode&&console.timeEnd("⏱️ Preview time"),this.debugMode&&console.time("⏱️ Toc time"),new en({config:this.config,DOM:t,selector:this.selector,node:n,layout:o}).render(),this.debugMode&&console.timeEnd("⏱️ Toc time"),this.debugMode&&console.time("⏱️ Validator time"),new tn({config:this.config,DOM:t,selector:this.selector,node:n,layout:o}).init(),this.debugMode&&console.timeEnd("⏱️ Validator time"),t.setAttribute(o.root,"[success]"),t.setAttribute(o.root,"[pages]",s.length),e.remove(),console.info("[HTML2PDF4DOC] Page count:",s.length),console.timeEnd("[HTML2PDF4DOC] Total time")}}(ln),hn="manual"===ln.init;function cn(){hn&&an.render()}hn&&console.info("HTML2PDF4DOC in manual initialization mode"),!hn&&an.render(),HTML2PDF4DOC=t})();